// ğŸ¤– NUPI AI - AUTOMATED CUSTOMER AI CREATION SYSTEM
// Automatically creates personalized Telegram bots for customers after Stripe payment

const express = require('express');
const axios = require('axios');
const fs = require('fs').promises;
const path = require('path');

// Configuration
const STRIPE_WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET || 'whsec_your_webhook_secret';
// NOTE: This module generates bot code for CUSTOMERS - it doesn't run a bot itself
// Customer bots will use their own tokens provided during order fulfillment
const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY || 'your-claude-api-key-here';
const BOTFATHER_USERNAME = '@BotFather';

// Storage paths
const CUSTOMERS_DB = path.join(__dirname, 'customers.json');
const BOTS_DB = path.join(__dirname, 'customer_bots.json');

// Initialize databases
let customersData = { customers: [] };
let botsData = { bots: [] };

// Load databases
async function loadDatabases() {
    try {
        const customersFile = await fs.readFile(CUSTOMERS_DB, 'utf-8');
        customersData = JSON.parse(customersFile);
        console.log('âœ… Customers database loaded');
    } catch (error) {
        console.log('ğŸ“ Creating new customers database');
        await saveDatabases();
    }
    
    try {
        const botsFile = await fs.readFile(BOTS_DB, 'utf-8');
        botsData = JSON.parse(botsFile);
        console.log('âœ… Bots database loaded');
    } catch (error) {
        console.log('ğŸ“ Creating new bots database');
        await saveDatabases();
    }
}

// Save databases
async function saveDatabases() {
    await fs.writeFile(CUSTOMERS_DB, JSON.stringify(customersData, null, 2));
    await fs.writeFile(BOTS_DB, JSON.stringify(botsData, null, 2));
    console.log('ğŸ’¾ Databases saved');
}

// ğŸ¤– CREATE BOT CODE FILE
async function generateBotCode(customerData) {
    const { name, email, personality, useCase, botToken } = customerData;
    
    const botCode = `// ğŸ¤– ${name}'s Personal AI Assistant
// AUTO-GENERATED by NUPI AI System
// Created: ${new Date().toISOString()}

const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');

const BOT_TOKEN = '${botToken}';
const CLAUDE_API_KEY = '${CLAUDE_API_KEY}';
const OWNER_NAME = '${name}';
const OWNER_EMAIL = '${email}';

const bot = new TelegramBot(BOT_TOKEN, { polling: true });

// ğŸ’¾ Conversation memory
const conversations = {};

// ğŸ¨ Personality: ${personality}
// ğŸ’¼ Use Case: ${useCase}
const getSystemPrompt = () => {
    return \`You are \${OWNER_NAME}'s personal AI assistant with a ${personality} personality.

You are specifically optimized for: ${useCase}

YOUR PERSONALITY:
${personality === 'professional' ? '- Professional, efficient, and business-oriented\n- Clear and concise communication\n- Focus on productivity and results' : ''}
${personality === 'friendly' ? '- Warm, casual, and conversational\n- Use emojis naturally ğŸ˜Š\n- Be supportive and encouraging' : ''}
${personality === 'creative' ? '- Think outside the box\n- Enthusiastic and inspiring\n- Help brainstorm and ideate' : ''}
${personality === 'technical' ? '- Detail-oriented and precise\n- Explain technical concepts clearly\n- Provide code examples and solutions' : ''}

YOUR EXPERTISE: ${useCase}

IMPORTANT:
- Remember \${OWNER_NAME}'s preferences
- Be proactive and helpful
- Answer naturally and conversationally
- You're available 24/7

Current Date: \${new Date().toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
})}
\`;
};

// ğŸ§  Get AI Response
async function getAIResponse(chatId, userMessage) {
    try {
        if (!conversations[chatId]) {
            conversations[chatId] = [];
        }
        
        conversations[chatId].push({
            role: 'user',
            content: userMessage
        });
        
        // Keep last 20 messages
        if (conversations[chatId].length > 20) {
            conversations[chatId] = conversations[chatId].slice(-20);
        }
        
        const response = await axios.post(
            'https://api.anthropic.com/v1/messages',
            {
                model: 'claude-3-haiku-20240307',
                max_tokens: 1024,
                system: getSystemPrompt(),
                messages: conversations[chatId]
            },
            {
                headers: {
                    'x-api-key': CLAUDE_API_KEY,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json'
                }
            }
        );
        
        const aiMessage = response.data.content[0].text;
        
        conversations[chatId].push({
            role: 'assistant',
            content: aiMessage
        });
        
        return aiMessage;
        
    } catch (error) {
        console.error('AI Error:', error.message);
        return "I'm having trouble connecting right now. Please try again in a moment! ğŸ”„";
    }
}

// ğŸ“± Handle Messages
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    
    if (!text || text.startsWith('/')) return;
    
    console.log(\`ğŸ’¬ \${msg.from.first_name}: \${text}\`);
    
    bot.sendChatAction(chatId, 'typing');
    
    try {
        const response = await getAIResponse(chatId, text);
        bot.sendMessage(chatId, response);
        console.log(\`âœ… Responded to \${msg.from.first_name}\`);
    } catch (error) {
        console.error('Error:', error.message);
        bot.sendMessage(chatId, 'âš ï¸ Oops! Something went wrong. Try again?');
    }
});

// ğŸš€ Start command
bot.onText(/\\/start/, (msg) => {
    const chatId = msg.chat.id;
    const welcomeMessage = \`
ğŸ‰ **Welcome, ${name}!**

I'm your personal AI assistant, powered by Claude AI. I'm here to help you with ${useCase.toLowerCase()} and anything else you need!

**ğŸ­ My Personality:** ${personality.charAt(0).toUpperCase() + personality.slice(1)}
**ğŸ’¼ Specialized in:** ${useCase}

**How to use me:**
Just send me any message! I can:
â€¢ Answer questions
â€¢ Help with tasks
â€¢ Provide advice
â€¢ Have conversations
â€¢ Remember our previous chats

Let's get started! What would you like to talk about? ğŸ’¬
    \`;
    
    bot.sendMessage(chatId, welcomeMessage, { parse_mode: 'Markdown' });
    console.log(\`âœ… \${msg.from.first_name} started the bot\`);
});

// ğŸ“Š Help command
bot.onText(/\\/help/, (msg) => {
    const chatId = msg.chat.id;
    const helpMessage = \`
ğŸ¤– **Your Personal AI Assistant**

**Commands:**
/start - Welcome message
/help - This help menu
/clear - Clear conversation history

**Just talk to me naturally!** I can help with:
âœ… ${useCase}
âœ… Questions & answers
âœ… Problem solving
âœ… Brainstorming
âœ… Advice & guidance

**Support:** ${email}

I'm here 24/7! ğŸš€
    \`;
    
    bot.sendMessage(chatId, helpMessage, { parse_mode: 'Markdown' });
});

// ğŸ§¹ Clear conversation
bot.onText(/\\/clear/, (msg) => {
    const chatId = msg.chat.id;
    conversations[chatId] = [];
    bot.sendMessage(chatId, 'âœ… Conversation cleared! Starting fresh. ğŸ†•');
});

console.log(\`âœ… ${name}'s AI Assistant is ONLINE! ğŸ¤–\`);
console.log(\`ğŸ­ Personality: ${personality}\`);
console.log(\`ğŸ’¼ Use Case: ${useCase}\`);
console.log(\`ğŸ“± Ready to help ${name}!\`);
`;

    return botCode;
}

// ğŸ“ SEND INSTRUCTIONS TO CUSTOMER
async function sendBotCreationInstructions(customerData) {
    const { email, name } = customerData;
    
    const instructions = `
ğŸ‰ YOUR PERSONAL AI IS READY TO BUILD!

Hi ${name}!

Follow these simple steps to activate your AI:

1ï¸âƒ£ **Open Telegram** on your phone/computer

2ï¸âƒ£ **Search for @BotFather** (official Telegram bot)

3ï¸âƒ£ **Send these commands:**
   â€¢ Type: /newbot
   â€¢ Bot name: "${name}'s AI Assistant" (or anything you like)
   â€¢ Username: Must end in "bot" (example: ${name.toLowerCase().replace(/\s/g, '')}ai_bot)
   
4ï¸âƒ£ **Copy your bot token** - It looks like: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

5ï¸âƒ£ **Reply to this email with:**
   Subject: "Bot Token"
   Body: Paste your bot token

6ï¸âƒ£ **We'll activate your AI within 5 minutes!**

Need help? Reply to this email or visit: https://nupiai.com/support

Can't wait to get you started! ğŸš€

- NUPI AI Team
    `;
    
    // In production, send actual email here
    console.log(`ğŸ“§ Email Instructions Sent to: ${email}`);
    console.log(instructions);
    
    return instructions;
}

// ğŸš€ ACTIVATE CUSTOMER BOT
async function activateCustomerBot(customerData, botToken) {
    try {
        console.log(`\nğŸ¤– ACTIVATING BOT FOR: ${customerData.name}`);
        console.log(`ğŸ“§ Email: ${customerData.email}`);
        console.log(`ğŸ­ Personality: ${customerData.personality}`);
        console.log(`ğŸ’¼ Use Case: ${customerData.useCase}`);
        
        // Generate bot code
        const botCode = await generateBotCode({
            ...customerData,
            botToken
        });
        
        // Save bot code
        const botFileName = `customer_bot_${customerData.customerId}.js`;
        const botFilePath = path.join(__dirname, 'customer_bots', botFileName);
        
        // Create directory if it doesn't exist
        await fs.mkdir(path.join(__dirname, 'customer_bots'), { recursive: true });
        await fs.writeFile(botFilePath, botCode);
        
        console.log(`ğŸ’¾ Bot code saved: ${botFileName}`);
        
        // Send welcome message to customer
        const welcomeMessage = `
ğŸ‰ <b>YOUR AI IS NOW ACTIVE!</b>

Hi ${customerData.name}! ğŸ¤–

Your personal AI assistant is ready to help you!

<b>ğŸ­ Personality:</b> ${customerData.personality.charAt(0).toUpperCase() + customerData.personality.slice(1)}
<b>ğŸ’¼ Optimized for:</b> ${customerData.useCase}
<b>ğŸ“… Activated:</b> ${new Date().toLocaleDateString()}

<b>How to use:</b>
â€¢ Just send any message to start chatting
â€¢ I remember our conversations
â€¢ I'm available 24/7
â€¢ Type /help for more info

<i>What would you like to talk about?</i> ğŸ’¬

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Need help? Email: jdautotintsllc@icloud.com
        `;
        
        // Get chat ID by having customer send /start first
        const testUrl = `https://api.telegram.org/bot${botToken}/getUpdates`;
        const testResponse = await axios.get(testUrl);
        
        let chatId = null;
        if (testResponse.data.result && testResponse.data.result.length > 0) {
            chatId = testResponse.data.result[testResponse.data.result.length - 1].message.chat.id;
        }
        
        if (chatId) {
            // Send welcome message
            const sendUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
            await axios.post(sendUrl, {
                chat_id: chatId,
                text: welcomeMessage,
                parse_mode: 'HTML'
            });
            
            console.log(`âœ… Welcome message sent!`);
        } else {
            console.log(`âš ï¸ Customer needs to send /start to their bot first`);
        }
        
        // Save to database
        botsData.bots.push({
            customerId: customerData.customerId,
            name: customerData.name,
            email: customerData.email,
            botToken: botToken,
            botFileName: botFileName,
            chatId: chatId,
            activated: new Date().toISOString(),
            personality: customerData.personality,
            useCase: customerData.useCase
        });
        
        await saveDatabases();
        
        console.log(`âœ… BOT ACTIVATED SUCCESSFULLY!`);
        
        return {
            success: true,
            botFileName,
            chatId,
            message: 'Bot activated and running!'
        };
        
    } catch (error) {
        console.error(`âŒ Error activating bot:`, error.message);
        return {
            success: false,
            error: error.message
        };
    }
}

// ğŸ’³ STRIPE WEBHOOK HANDLER
async function handleStripeWebhook(event) {
    try {
        console.log(`\nğŸ’³ STRIPE EVENT: ${event.type}`);
        
        if (event.type === 'checkout.session.completed' || event.type === 'payment_intent.succeeded') {
            const session = event.data.object;
            
            // Extract customer data from metadata
            const customerData = {
                customerId: session.customer || `CUST_${Date.now()}`,
                name: session.customer_details?.name || session.metadata?.name || 'Customer',
                email: session.customer_details?.email || session.metadata?.email || 'no-email@example.com',
                personality: session.metadata?.personality || 'friendly',
                useCase: session.metadata?.useCase || 'General Assistant',
                amountPaid: session.amount_total / 100,
                currency: session.currency?.toUpperCase() || 'USD',
                paymentDate: new Date().toISOString()
            };
            
            console.log(`âœ… PAYMENT RECEIVED from ${customerData.name}`);
            console.log(`ğŸ’° Amount: $${customerData.amountPaid} ${customerData.currency}`);
            
            // Save customer
            customersData.customers.push(customerData);
            await saveDatabases();
            
            // Send bot creation instructions
            await sendBotCreationInstructions(customerData);
            
            return {
                success: true,
                customerId: customerData.customerId,
                message: 'Customer saved, instructions sent'
            };
        }
        
        return { success: true, message: 'Event processed' };
        
    } catch (error) {
        console.error('Webhook Error:', error);
        return { success: false, error: error.message };
    }
}

// Export functions
module.exports = {
    loadDatabases,
    saveDatabases,
    handleStripeWebhook,
    activateCustomerBot,
    generateBotCode,
    sendBotCreationInstructions
};

// If run directly
if (require.main === module) {
    (async () => {
        await loadDatabases();
        console.log('âœ… Automated AI Creator System Ready!');
        console.log('ğŸ“Š Customers:', customersData.customers.length);
        console.log('ğŸ¤– Active Bots:', botsData.bots.length);
    })();
}
