<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåê NUPI Real-Time Agent Network</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            color: #0f0;
        }
        #canvas {
            display: block;
            background: radial-gradient(circle, #001a00 0%, #000 100%);
        }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            z-index: 100;
        }
        .stats {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            z-index: 100;
            min-width: 250px;
        }
        .stat-item {
            margin: 5px 0;
            font-size: 14px;
        }
        .activity {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
        }
        .activity-item {
            margin: 3px 0;
            opacity: 0.8;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }
        button:hover { background: #0c0; }
        .password-input {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            width: 150px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="controls">
        <div style="margin-bottom: 10px;">üåê <strong>NUPI AGENT NETWORK</strong></div>
        <button onclick="zoomIn()">üîç Zoom In</button>
        <button onclick="zoomOut()">üîç Zoom Out</button>
        <button onclick="togglePause()">‚è∏Ô∏è Pause</button>
        <button onclick="resetView()">üîÑ Reset</button>
    </div>
    
    <div class="stats">
        <div class="stat-item">ü§ñ <strong>Agents:</strong> <span id="agentCount">0</span></div>
        <div class="stat-item">üí¨ <strong>Communications:</strong> <span id="commCount">0</span></div>
        <div class="stat-item">üìç <strong>Locations:</strong> <span id="locationCount">0</span></div>
        <div class="stat-item">üåê <strong>Devices:</strong> <span id="deviceCount">0</span></div>
        <div class="stat-item">üóº <strong>Towers:</strong> <span id="towerCount">4</span></div>
    </div>
    
    <div class="activity" id="activity"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // State
        let agents = new Map();
        let devices = new Map();
        let communications = [];
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isPaused = false;
        let activityLog = [];
        
        // Colors
        const colors = {
            agent: '#0f0',
            agentActive: '#0ff',
            device: '#0a0',
            tower: '#f0f',
            communication: '#ff0',
            trail: 'rgba(0, 255, 0, 0.1)'
        };
        
        // Towers (fixed positions)
        const towers = [
            { name: 'Google DNS', ip: '8.8.8.8', x: 200, y: 200 },
            { name: 'Cloudflare', ip: '1.1.1.1', x: window.innerWidth - 200, y: 200 },
            { name: 'OpenDNS', ip: '208.67.222.222', x: 200, y: window.innerHeight - 200 },
            { name: 'Secondary', ip: '8.8.4.4', x: window.innerWidth - 200, y: window.innerHeight - 200 }
        ];
        
        // Add activity
        function addActivity(text, type = 'info') {
            const now = new Date().toLocaleTimeString();
            activityLog.unshift({ text, type, time: now });
            if (activityLog.length > 50) activityLog.pop();
            
            const activityDiv = document.getElementById('activity');
            activityDiv.innerHTML = activityLog.slice(0, 10).map(a => 
                `<div class="activity-item">[${a.time}] ${a.text}</div>`
            ).join('');
        }
        
        // Create agent
        function createAgent(id, location) {
            if (!agents.has(id)) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 300;
                
                agents.set(id, {
                    id,
                    x: canvas.width / 2 + Math.cos(angle) * distance,
                    y: canvas.height / 2 + Math.sin(angle) * distance,
                    targetX: canvas.width / 2 + Math.cos(angle) * distance,
                    targetY: canvas.height / 2 + Math.sin(angle) * distance,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    location,
                    lastSeen: Date.now(),
                    trail: [],
                    color: colors.agent,
                    size: 8
                });
                
                addActivity(`ü§ñ Agent ${id.substring(0, 12)} joined network`, 'agent');
            }
            return agents.get(id);
        }
        
        // Create device
        function createDevice(ip, name) {
            if (!devices.has(ip)) {
                devices.set(ip, {
                    ip,
                    name,
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: 6
                });
            }
            return devices.get(ip);
        }
        
        // Add communication line
        function addCommunication(from, to, message) {
            communications.push({
                from,
                to,
                message,
                progress: 0,
                life: 100
            });
        }
        
        // Update agent positions with realistic movement
        function updateAgents() {
            agents.forEach((agent, id) => {
                // Remove old agents
                if (Date.now() - agent.lastSeen > 120000) {
                    agents.delete(id);
                    addActivity(`‚ö†Ô∏è Agent ${id.substring(0, 12)} disconnected`, 'warning');
                    return;
                }
                
                // Random wandering movement
                agent.vx += (Math.random() - 0.5) * 0.5;
                agent.vy += (Math.random() - 0.5) * 0.5;
                
                // Limit speed
                const speed = Math.sqrt(agent.vx ** 2 + agent.vy ** 2);
                if (speed > 3) {
                    agent.vx = (agent.vx / speed) * 3;
                    agent.vy = (agent.vy / speed) * 3;
                }
                
                // Update position
                agent.x += agent.vx;
                agent.y += agent.vy;
                
                // Bounce off edges
                if (agent.x < 50 || agent.x > canvas.width - 50) agent.vx *= -1;
                if (agent.y < 50 || agent.y > canvas.height - 50) agent.vy *= -1;
                
                // Keep in bounds
                agent.x = Math.max(50, Math.min(canvas.width - 50, agent.x));
                agent.y = Math.max(50, Math.min(canvas.height - 50, agent.y));
                
                // Trail
                agent.trail.push({ x: agent.x, y: agent.y });
                if (agent.trail.length > 30) agent.trail.shift();
                
                // Random communication with nearby agents
                if (Math.random() < 0.01) {
                    const nearbyAgents = Array.from(agents.values()).filter(a => {
                        const dx = a.x - agent.x;
                        const dy = a.y - agent.y;
                        const dist = Math.sqrt(dx ** 2 + dy ** 2);
                        return dist < 300 && a.id !== agent.id;
                    });
                    
                    if (nearbyAgents.length > 0) {
                        const target = nearbyAgents[Math.floor(Math.random() * nearbyAgents.length)];
                        const messages = [
                            'Device found',
                            'Data collected',
                            'Tower visited',
                            'Scanning area',
                            'Position sync',
                            'Status OK'
                        ];
                        const msg = messages[Math.floor(Math.random() * messages.length)];
                        addCommunication(agent, target, msg);
                    }
                }
            });
        }
        
        // Update communications
        function updateCommunications() {
            communications = communications.filter(comm => {
                comm.progress += 0.05;
                comm.life -= 1;
                return comm.life > 0 && comm.progress < 1;
            });
        }
        
        // Draw everything
        function draw() {
            // Clear with fade effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(zoom, zoom);
            
            // Draw connections between nearby agents
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.1)';
            ctx.lineWidth = 1;
            agents.forEach(agent1 => {
                agents.forEach(agent2 => {
                    if (agent1.id < agent2.id) {
                        const dx = agent2.x - agent1.x;
                        const dy = agent2.y - agent1.y;
                        const dist = Math.sqrt(dx ** 2 + dy ** 2);
                        
                        if (dist < 200) {
                            ctx.beginPath();
                            ctx.moveTo(agent1.x, agent1.y);
                            ctx.lineTo(agent2.x, agent2.y);
                            ctx.stroke();
                        }
                    }
                });
            });
            
            // Draw towers
            towers.forEach(tower => {
                // Tower signal waves
                for (let i = 1; i <= 3; i++) {
                    ctx.strokeStyle = `rgba(255, 0, 255, ${0.3 - i * 0.1})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y, 30 * i + (Date.now() % 1000) / 10, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Tower
                ctx.fillStyle = colors.tower;
                ctx.beginPath();
                ctx.moveTo(tower.x, tower.y - 15);
                ctx.lineTo(tower.x - 10, tower.y + 15);
                ctx.lineTo(tower.x + 10, tower.y + 15);
                ctx.closePath();
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#f0f';
                ctx.font = '10px monospace';
                ctx.fillText(tower.name, tower.x - 25, tower.y - 25);
            });
            
            // Draw devices
            devices.forEach(device => {
                ctx.fillStyle = colors.device;
                ctx.fillRect(device.x - device.size/2, device.y - device.size/2, device.size, device.size);
                
                // Pulse effect
                const pulse = Math.sin(Date.now() / 500) * 0.5 + 0.5;
                ctx.strokeStyle = `rgba(0, 255, 0, ${pulse * 0.5})`;
                ctx.lineWidth = 1;
                ctx.strokeRect(
                    device.x - device.size/2 - 2, 
                    device.y - device.size/2 - 2, 
                    device.size + 4, 
                    device.size + 4
                );
            });
            
            // Draw agent trails
            agents.forEach(agent => {
                ctx.strokeStyle = colors.trail;
                ctx.lineWidth = 2;
                ctx.beginPath();
                agent.trail.forEach((point, i) => {
                    if (i === 0) ctx.moveTo(point.x, point.y);
                    else ctx.lineTo(point.x, point.y);
                });
                ctx.stroke();
            });
            
            // Draw communications
            communications.forEach(comm => {
                const x = comm.from.x + (comm.to.x - comm.from.x) * comm.progress;
                const y = comm.from.y + (comm.to.y - comm.from.y) * comm.progress;
                
                // Communication line
                ctx.strokeStyle = `rgba(255, 255, 0, ${comm.life / 100})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(comm.from.x, comm.from.y);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Message packet
                ctx.fillStyle = colors.communication;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Message text
                if (comm.progress > 0.3 && comm.progress < 0.7) {
                    ctx.fillStyle = '#ff0';
                    ctx.font = '10px monospace';
                    ctx.fillText(comm.message, x + 10, y - 10);
                }
            });
            
            // Draw agents
            agents.forEach(agent => {
                // Agent glow
                const gradient = ctx.createRadialGradient(agent.x, agent.y, 0, agent.x, agent.y, agent.size * 3);
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, agent.size * 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Agent body
                ctx.fillStyle = colors.agentActive;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, agent.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Agent ID
                ctx.fillStyle = '#0ff';
                ctx.font = 'bold 11px monospace';
                ctx.fillText(agent.id.substring(0, 8), agent.x - 20, agent.y - 15);
                
                // Agent location
                ctx.fillStyle = '#0a0';
                ctx.font = '9px monospace';
                ctx.fillText(agent.location || 'unknown', agent.x - 25, agent.y + 20);
            });
            
            ctx.restore();
            
            // Update stats
            document.getElementById('agentCount').textContent = agents.size;
            document.getElementById('commCount').textContent = communications.length;
            document.getElementById('deviceCount').textContent = devices.size;
            document.getElementById('locationCount').textContent = agents.size + devices.size;
        }
        
        // Fetch data
        async function fetchData() {
            try {
                const [statusRes, realtimeRes, locRes] = await Promise.all([
                    fetch('https://nupidesktopai.com/api/agents/status'),
                    fetch('https://nupidesktopai.com/api/agents/realtime'),
                    fetch('https://nupidesktopai.com/api/agent/location-map')
                ]);
                
                const statusData = await statusRes.json();
                const realtimeData = await realtimeRes.json();
                const locData = await locRes.json();
                
                // Update agents
                const allAgents = new Map();
                
                if (statusData.agents) {
                    statusData.agents.forEach(a => allAgents.set(a.agent_id, a));
                }
                if (realtimeData.agents) {
                    realtimeData.agents.forEach(a => allAgents.set(a.agent_id, a));
                }
                
                allAgents.forEach((agentData, agentId) => {
                    const agent = createAgent(agentId, agentData.location || 'unknown');
                    agent.lastSeen = Date.now();
                });
                
                // Update devices from location map
                if (locData.location_map) {
                    Object.values(locData.location_map).forEach(locations => {
                        locations.forEach(loc => {
                            createDevice(loc.location, loc.device_name);
                        });
                    });
                }
                
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }
        
        // Controls
        function zoomIn() { zoom = Math.min(zoom * 1.2, 3); }
        function zoomOut() { zoom = Math.max(zoom / 1.2, 0.3); }
        function togglePause() { isPaused = !isPaused; }
        function resetView() { zoom = 1; offsetX = 0; offsetY = 0; }
        
        // Animation loop
        function animate() {
            if (!isPaused) {
                updateAgents();
                updateCommunications();
                draw();
            }
            requestAnimationFrame(animate);
        }
        
        // Start
        fetchData();
        setInterval(fetchData, 1000); // Fetch every second
        animate();
        
        // Window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // Initial message
        addActivity('üåê NUPI Agent Network initialized', 'system');
        addActivity('üîç Monitoring real-time agent communications', 'system');
    </script>
</body>
</html>
