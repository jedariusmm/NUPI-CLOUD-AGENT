<!-- VERSION: LIVE-DEPLOY-1765116252 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí NUPI Complete Dashboard - All Functions</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            color: #0f0;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
        }
        
        .login-box {
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border: 3px solid #0f0;
            border-radius: 15px;
            box-shadow: 0 0 40px #0f0;
            max-width: 450px;
            width: 100%;
        }
        
        .login-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 30px;
            color: #0ff;
            text-shadow: 0 0 15px #0ff;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #0ff;
            font-size: 16px;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            background: #000;
            border: 2px solid #0f0;
            border-radius: 8px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 18px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 15px #0ff;
        }
        
        .login-btn {
            width: 100%;
            padding: 18px;
            background: #0f0;
            color: #000;
            border: none;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: #0ff;
            box-shadow: 0 0 25px #0ff;
            transform: scale(1.02);
        }
        
        .error-msg {
            color: #f00;
            text-align: center;
            margin-top: 20px;
            font-size: 16px;
            display: none;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .login-hint {
            text-align: center;
            color: #0ff;
            font-size: 12px;
            margin-top: 15px;
            opacity: 0.7;
        }
        
        /* Main Dashboard */
        .dashboard {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
            background: radial-gradient(circle at 50% 50%, #001a00 0%, #000 100%);
        }
        
        #canvas.dragging {
            cursor: grabbing;
        }
        
        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 3px solid #0f0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .dashboard-title {
            font-size: 24px;
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
            font-weight: bold;
        }
        
        .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .live-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #0f0;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px #0f0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        button {
            padding: 10px 20px;
            background: #0f0;
            color: #000;
            border: none;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #0ff;
            box-shadow: 0 0 15px #0ff;
            transform: translateY(-2px);
        }
        
        .btn-logout {
            background: #f00;
            color: #fff;
        }
        
        .btn-logout:hover {
            background: #ff0;
            color: #000;
        }
        
        /* Side Panel - Stats */
        .side-panel {
            position: fixed;
            right: 0;
            top: 70px;
            bottom: 0;
            width: 380px;
            background: rgba(0, 0, 0, 0.98);
            border-left: 3px solid #0f0;
            overflow-y: auto;
            z-index: 999;
            box-shadow: -5px 0 30px rgba(0, 255, 0, 0.3);
        }
        
        .panel-section {
            padding: 20px;
            border-bottom: 2px solid #0f0;
        }
        
        .section-title {
            font-size: 18px;
            color: #0ff;
            margin-bottom: 15px;
            font-weight: bold;
            text-shadow: 0 0 5px #0ff;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .stat-label {
            color: #0f0;
        }
        
        .stat-value {
            color: #0ff;
            font-weight: bold;
        }
        
        .agent-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .agent-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #0f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-item:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .agent-item.offline {
            background: rgba(255, 0, 0, 0.1);
            border-left-color: #f00;
        }
        
        /* Bottom Panel - Activity & Data */
        .bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 380px;
            height: 200px;
            background: rgba(0, 0, 0, 0.98);
            border-top: 3px solid #0f0;
            z-index: 999;
            display: flex;
            box-shadow: 0 -5px 30px rgba(0, 255, 0, 0.3);
        }
        
        .activity-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            border-right: 2px solid #0f0;
        }
        
        .data-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .activity-item {
            font-size: 11px;
            padding: 4px;
            margin: 3px 0;
            opacity: 0.9;
        }
        
        .activity-enter { color: #0ff; }
        .activity-leave { color: #ff0; }
        .activity-travel { color: #f0f; }
        .activity-data { color: #0f0; }
        
        .data-item {
            font-size: 12px;
            padding: 5px;
            margin: 5px 0;
            color: #f0f;
        }
        
        /* Controls Panel */
        .controls-panel {
            position: fixed;
            top: 80px;
            left: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border: 2px solid #0f0;
            border-radius: 10px;
            z-index: 999;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            transition: transform 0.3s ease, opacity 0.3s ease;
        
            display: none;
            display: none;
            display: none !important;}
        .controls-panel.collapsed {
            transform: translateX(-350px);
            opacity: 0.2;
        }
        .collapse-btn {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #0f0, #0c0);
            border: 2px solid #0f0;
            color: #000;
            font-weight: bold;
            padding: 15px 8px;
            cursor: pointer;
            border-radius: 0 10px 10px 0;
            font-size: 18px;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        .collapse-btn:hover {
            background: linear-gradient(135deg, #0f0, #0f0);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        .control-btn {
            width: 100%;
            margin: 5px 0;
            padding: 12px;
            font-size: 14px;
        }
        
        /* Agent Details Popup */
        .agent-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.98);
            border: 3px solid #0ff;
            border-radius: 15px;
            padding: 25px;
            min-width: 450px;
            max-width: 600px;
            z-index: 3000;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.6), inset 0 0 30px rgba(0, 255, 255, 0.1);
            animation: popupSlide 0.3s ease;
        }
        
        @keyframes popupSlide {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        
        .agent-popup h2 {
            color: #0ff;
            margin: 0 0 20px 0;
            font-size: 24px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        
        .agent-popup .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 8px 0;
            background: rgba(0, 255, 255, 0.05);
            border-left: 3px solid #0ff;
            border-radius: 5px;
        }
        
        .agent-popup .detail-label {
            color: #0ff;
            font-weight: bold;
        }
        
        .agent-popup .detail-value {
            color: #fff;
            text-align: right;
        }
        
        .agent-popup .close-popup-btn {
            background: linear-gradient(135deg, #0ff, #08f);
            border: none;
            color: #000;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .agent-popup .close-popup-btn:hover {
            background: linear-gradient(135deg, #0ff, #0ff);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            transform: scale(1.05);
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2999;
        }
        
        /* Raw Data Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #000;
            border: 3px solid #0f0;
            border-radius: 10px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
        }
        
        .modal-title {
            font-size: 24px;
            color: #0ff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0ff;
        }
        
        .raw-data-display {
            background: #000;
            color: #0f0;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 5px;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .close-btn {
            background: #f00;
            color: #fff;
            margin-top: 15px;
        }
        
        .copy-btn {
            background: #f0f;
            color: #fff;
            margin-top: 15px;
            margin-left: 10px;
        }
    
        /* Floating Menu */
        .floating-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #0ff;
            border-radius: 15px;
            padding: 15px;
            z-index: 5000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
        
            display: none;
            display: none;
            display: none !important;}
        
        .menu-btn {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 12px 20px;
            background: linear-gradient(135deg, #0ff, #08f);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        
        .menu-btn:hover {
            background: linear-gradient(135deg, #0ff, #0ff);
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.8);
        }
        
        .menu-btn.active {
            background: linear-gradient(135deg, #0f0, #0c0);
        }
        
        /* Hide panels by default */
        .controls-panel.hidden {
            display: none !important;
        }

    
        /* Always-visible toggle button */
        .show-menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #0ff, #08f);
            border: 2px solid #0ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .show-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(0, 255, 255, 1);
        }

    
        /* Always-visible toggle button */
        .show-menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #0ff, #08f);
            border: 2px solid #0ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .show-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(0, 255, 255, 1);
        }

    
        /* Hide all non-login elements on login screen */
        body.login-active .activity-log,
        body.login-active .tower-visits,
        body.login-active canvas,
        body.login-active .controls-panel,
        body.login-active .floating-menu,
        body.login-active .show-menu-btn {
            display: none !important;
        }
        
        /* Show only login screen */
        .login-screen {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
        }

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-title">üîí NUPI COMPLETE DASHBOARD</div>
            <div class="login-title" style="font-size: 16px; margin-bottom: 30px;">Visualizer + Data + Real-Time Monitoring</div>
            <form id="loginForm" onsubmit="return login(event)">
                <div class="input-group">
                    <label>üë§ Username:</label>
                    <input type="text" id="username" required autofocus placeholder="admin">
                </div>
                <div class="input-group">
                    <label>üîë Password:</label>
                    <input type="password" id="password" required placeholder="nupi2025">
                </div>
                <button type="submit" class="login-btn">üöÄ ACCESS SYSTEM</button>
                <div class="error-msg" id="errorMsg">‚ùå Invalid credentials! Try again.</div>
                <div class="login-hint">üí° Default: admin / nupi2025</div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <canvas id="canvas"></canvas>
        
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="dashboard-title">üåê NUPI COMPLETE CONTROL CENTER</div>
            <div class="top-controls">
                <div class="live-indicator"></div>
                <span style="color: #0f0; margin-right: 20px;">SYSTEM ONLINE</span>
                <button onclick="toggleLiveMap()">üó∫Ô∏è Live Network Map</button>
                <button onclick="showDataPage()">ÔøΩ Data Viewer</button>
                <button onclick="showRawData()">üìÑ Raw Data</button>
                <button onclick="resetView()">üîÑ Reset View</button>
                <button class="btn-logout" onclick="logout()">üîì Logout</button>
            </div>
        </div>
        
        
    
    <!-- Always-visible menu toggle button -->
    <button class="show-menu-btn" onclick="toggleMainMenu()" title="Show Menu">‚ò∞</button>

    
    <!-- Always-visible menu toggle button -->
    <button class="show-menu-btn" onclick="toggleMainMenu()" title="Show Menu">‚ò∞</button>

    <!-- Floating Menu -->
    <div class="floating-menu" id="floatingMenu">
        <button class="menu-btn" onclick="togglePanel('controlsPanel')">üéÆ Controls</button>
        <button class="menu-btn" onclick="togglePanel('statsPanel')">üìä Statistics</button>
        <button class="menu-btn" onclick="showDataViewer()">üíæ Data Storage</button>
        <button class="menu-btn" onclick="showPaymentCaptures()">üí∞ Payments</button>
        <button class="menu-btn" onclick="logout()">üîì Logout</button>
    </div>
<!-- Controls Panel -->
        <div class="controls-panel" id="controlsPanel">
            <button class="collapse-btn" onclick="toggleControlsPanel()" id="collapseBtn">‚è™</button>
            <div class="section-title">üéÆ CONTROLS</div>
            <button class="control-btn" onclick="zoomIn()">üîç Zoom In</button>
            <button class="control-btn" onclick="zoomOut()">üîç Zoom Out</button>
            <button class="control-btn" onclick="togglePause()">‚è∏Ô∏è Pause/Play</button>
            <button class="control-btn" onclick="focusCloud()">‚òÅÔ∏è Focus Cloud</button>
            <button class="control-btn" onclick="followAgent()">üëÅÔ∏è Follow Agent</button>
        </div>
        
        <!-- Side Panel -->
        <div class="side-panel">
            <div class="panel-section">
                <div class="section-title">üìä LIVE STATISTICS</div>
                <div class="stat-item">
                    <span class="stat-label">ü§ñ Total Agents:</span>
                    <span class="stat-value" id="totalAgents">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚úÖ Online:</span>
                    <span class="stat-value" style="color: #0f0;" id="onlineAgents">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚ùå Offline:</span>
                    <span class="stat-value" style="color: #f00;" id="offlineAgents">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚òÅÔ∏è In Cloud:</span>
                    <span class="stat-value" id="cloudAgents">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üåç Traveling:</span>
                    <span class="stat-value" id="travelingAgents">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üóº At Towers:</span>
                    <span class="stat-value" id="atTowerAgents">0</span>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">üì° DATA COLLECTED</div>
                <div class="stat-item">
                    <span class="stat-label">Tower Data:</span>
                    <span class="stat-value" id="towerData">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">WiFi Devices:</span>
                    <span class="stat-value" id="wifiData">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Items:</span>
                    <span class="stat-value" id="totalData">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tower Visits:</span>
                    <span class="stat-value" id="towerVisits">0</span>
                </div>

                <div class="stat-item">
                    <span class="stat-label">üí∞ Payments Captured:</span>
                    <span class="stat-value" id="paymentsCaptured">REAL DATA ONLY</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üíµ Total USD:</span>
                    <span class="stat-value" id="totalUSD">$0.00</span>
                </div>

                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">üë• AGENT LIST</div>
                <div class="agent-list" id="agentList">
                    <div style="text-align: center; padding: 20px; color: #0ff;">Loading agents...</div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Panel -->
        <div class="bottom-panel">
            <div class="activity-panel">
                <div class="section-title">üìã ACTIVITY LOG</div>
                <div id="activityLog">
                    <div class="activity-item activity-data">System initializing...</div>
                </div>
            </div>
            <div class="data-panel">
                <div class="section-title">üóº TOWER VISITS</div>
                <div id="towerLog">
                    <div class="data-item">Waiting for tower visits...</div>
                </div>
            </div>
        </div>
        
        <!-- Raw Data Modal -->
        <div class="modal" id="rawDataModal">
            <div class="modal-content">
                <div class="modal-title">üìÑ RAW DATA EXPORT</div>
                <div class="raw-data-display" id="rawDataDisplay">Loading...</div>
                <button class="copy-btn" onclick="copyRawData()">üìã Copy All</button>
                <button class="close-btn" onclick="closeRawData()">‚úñÔ∏è Close</button>
            </div>
        </div>

        <!-- Live Network Map Overlay -->
        <div class="modal" id="networkMapModal" style="display: none;">
            <div class="modal-content" style="max-width: 90%; height: 85vh;">
                <div class="modal-title">üó∫Ô∏è LIVE NETWORK MAP - Cell Towers & WiFi Hubs</div>
                <canvas id="networkMapCanvas" width="1200" height="700" style="background: #000; border: 2px solid #0f0;"></canvas>
                <div style="color: #0f0; margin-top: 10px; font-size: 12px;">
                    üóº <span style="color: #f0f;">Cell Towers</span> | 
                    üì° <span style="color: #0ff;">WiFi Hubs</span> | 
                    ü§ñ <span style="color: #0f0;">Active Agents</span> | 
                    ‚ö° <span style="color: #ff0;">Signal Paths</span>
                </div>
                <button class="close-btn" onclick="closeLiveMap()">‚úñÔ∏è Close</button>
            </div>
        </div>

        <!-- Data Viewer Modal - COMPREHENSIVE PERSONAL DATA -->
        <div class="modal" id="dataViewerModal" style="display: none;">
            <div class="modal-content" style="max-width: 95%; height: 90vh; overflow-y: auto;">
                <div class="modal-title">üìä COMPREHENSIVE DEVICE DATA STORAGE</div>
                
                <!-- Search and Filters -->
                <div style="background: rgba(0,255,255,0.1); padding: 15px; margin-bottom: 20px; border: 2px solid #0ff; border-radius: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="color: #0ff; font-weight: bold;">üîç Search:</label>
                            <input type="text" id="searchFilter" placeholder="Name, IP, Phone, Email..." 
                                style="width: 100%; padding: 8px; background: #001; color: #0f0; border: 1px solid #0ff; border-radius: 5px;"
                                onkeyup="filterDataTable()">
                        </div>
                        <div>
                            <label style="color: #0ff; font-weight: bold;">ÔøΩ Device Type:</label>
                            <select id="deviceTypeFilter" onchange="filterDataTable()" 
                                style="width: 100%; padding: 8px; background: #001; color: #0f0; border: 1px solid #0ff; border-radius: 5px;">
                                <option value="">All Types</option>
                                <option value="Phone">üì± Phone</option>
                                <option value="Tablet">üì± Tablet</option>
                                <option value="Computer">üíª Computer</option>
                                <option value="TV">üì∫ Smart TV</option>
                                <option value="Console">üéÆ Game Console</option>
                                <option value="Router">üì° Router</option>
                                <option value="IoT">üè† IoT Device</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #0ff; font-weight: bold;">ü§ñ Agent:</label>
                            <select id="agentFilter" onchange="filterDataTable()" 
                                style="width: 100%; padding: 8px; background: #001; color: #0f0; border: 1px solid #0ff; border-radius: 5px;">
                                <option value="">All Agents</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #0ff; font-weight: bold;">üìä Total Found:</label>
                            <div style="padding: 8px; background: rgba(0,255,0,0.2); border: 1px solid #0f0; border-radius: 5px; text-align: center; font-weight: bold; color: #0f0;">
                                <span id="totalDevicesFound">0</span> devices
                            </div>
                        </div>
                    </div>
                    <button onclick="refreshDataTable()" style="margin-top: 10px; padding: 10px 20px; background: linear-gradient(135deg, #0f0, #0c0); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                        üîÑ Refresh Data
                    </button>
                    <button onclick="exportDataToCSV()" style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background: linear-gradient(135deg, #0ff, #08f); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                        üì• Export CSV
                    </button>
                </div>
                
                <!-- Data Table -->
                <div style="overflow-x: auto; background: rgba(0,0,0,0.95); border: 2px solid #0f0; border-radius: 10px;">
                    <table id="deviceDataTable" style="width: 100%; border-collapse: collapse; color: #0f0; font-family: monospace; font-size: 12px;">
                        <thead>
                            <tr style="background: rgba(0,255,0,0.2); position: sticky; top: 0;">
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üì± Device Name</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üåê IP Address</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">ÔøΩ Device Type</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üë§ Owner Name</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üìß Email</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üìû Phone Number</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üè† Address</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üîê Passwords</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">ü§ñ Agent</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">‚è∞ Collected</th>
                                <th style="padding: 12px; border: 1px solid #0f0; text-align: left; color: #0ff;">üì¶ Full Data</th>
                            </tr>
                        </thead>
                        <tbody id="deviceDataBody">
                            <tr>
                                <td colspan="11" style="padding: 30px; text-align: center; color: #ff0;">
                                    ‚è≥ Loading device data from nupidesktopai.com...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button class="close-btn" onclick="closeDataViewer()" style="margin-top: 20px;">‚úñÔ∏è Close</button>
            </div>
        </div>
    </div>

    <script>
        // === AUTHENTICATION ===
        const VALID_CREDS = { username: 'admin', password: 'nupi2025' };
        let isLoggedIn = false;
        
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === VALID_CREDS.username && password === VALID_CREDS.password) {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('errorMsg').style.display = 'none';
                initDashboard();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
            return false;
        }
        
        function logout() {
            isLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // === CANVAS SETUP ===
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // === WORLD DATA ===
        const TOWERS = [
            { name: 'California', ip: '8.8.8.8', x: 300, y: 400 },
            { name: 'London', ip: '1.1.1.1', x: 900, y: 250 },
            { name: 'New York', ip: '208.67.222.222', x: 650, y: 350 },
            { name: 'Tokyo', ip: '8.8.4.4', x: 1500, y: 380 }
        ];
        
        let agents = new Map();
        let particles = [];
        let communications = [];
        let towerIcons = [];
        let activityLog = [];
        let towerVisitLog = [];
        
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isPaused = false;
        let followingAgent = null;
        
        let totalTowerData = 76;
        let totalWifiData = 21;
        let totalVisits = 0;
        
        const nupiCloud = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 100,
            pulse: 0
        };
        
        // === MOUSE CONTROLS (DRAGGING) ===
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left - offsetX) / zoom;
            const mouseY = (e.clientY - rect.top - offsetY) / zoom;
            
            // Check if clicking on an agent
            let clickedAgent = null;
            for (const agent of agents.values()) {
                const dist = Math.sqrt((agent.x - mouseX) ** 2 + (agent.y - mouseY) ** 2);
                if (dist < agent.size + 10) {
                    clickedAgent = agent;
                    break;
                }
            }
            
            if (clickedAgent) {
                // Show agent details popup
                showAgentDetails(clickedAgent);
                return;
            }
            
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.classList.add('dragging');
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                offsetX += dx;
                offsetY += dy;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.classList.remove('dragging');
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            canvas.classList.remove('dragging');
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            zoom = Math.max(0.2, Math.min(5, zoom * zoomFactor));
        });
        
        // === ACTIVITY LOGGING ===
        function addActivity(text, type = 'info') {
            const now = new Date().toLocaleTimeString();
            activityLog.unshift({ text, type, time: now });
            if (activityLog.length > 50) activityLog.pop();
            
            const logDiv = document.getElementById('activityLog');
            logDiv.innerHTML = activityLog.slice(0, 15).map(a => 
                `<div class="activity-item activity-${a.type}">[${a.time}] ${a.text}</div>`
            ).join('');
        }
        
        function addTowerVisit(agentId, tower, dataPoints) {
            const now = new Date().toLocaleTimeString();
            towerVisitLog.unshift({ agentId, tower, dataPoints, time: now });
            if (towerVisitLog.length > 10) towerVisitLog.pop();
            
            const logDiv = document.getElementById('towerLog');
            logDiv.innerHTML = towerVisitLog.map(t => 
                `<div class="data-item">[${t.time}] ${t.agentId.substring(0, 15)} ‚Üí ${t.tower} (+${t.dataPoints})</div>`
            ).join('');
        }
        
        // === AGENT MANAGEMENT ===
        function createAgent(id, location, status, data) {
            const isNew = !agents.has(id);
            const now = Date.now();
            
            if (isNew) {
                // Spawn at RANDOM position across entire canvas (not in circle!)
                const spawnX = Math.random() * 1800 + 100;
                const spawnY = Math.random() * 900 + 100;
                
                // Pick random tower as initial target
                const targetTower = TOWERS[Math.floor(Math.random() * TOWERS.length)];
                
                agents.set(id, {
                    id, 
                    x: spawnX,
                    y: spawnY,
                    vx: 0, vy: 0, 
                    location, 
                    status: 'traveling',  // Start travelling immediately!
                    lastSeen: now, 
                    trail: [], 
                    size: 12,
                    inCloud: false, 
                    traveling: true,  // Actually traveling!
                    targetTower: targetTower,  // Has destination!
                    isOnline: true, 
                    devicesFound: data?.devices_found || 0,
                    dataPackets: []  // For visible data transfer
                });
                
                addActivity(`ÔøΩ ${id.substring(0, 20)} ‚Üí ${targetTower.name}`, 'travel');
                
                // Spawn particles at random location
                for (let i = 0; i < 20; i++) {
                    particles.push({
                        x: spawnX, y: spawnY,
                        vx: (Math.random() - 0.5) * 5, vy: (Math.random() - 0.5) * 5,
                        life: 50, color: '#0f0'
                    });
                }
            } else {
                const agent = agents.get(id);
                agent.lastSeen = now;
                agent.isOnline = true;
                agent.devicesFound = data?.devices_found || agent.devicesFound;
            }
            
            return agents.get(id);
        }
        
        // === AGENT BEHAVIOR ===
        function updateAgents() {
            const now = Date.now();
            
            agents.forEach((agent, id) => {
                if (now - agent.lastSeen > 60000 && agent.isOnline) {
                    agent.isOnline = false;
                    addActivity(`üî¥ ${id.substring(0, 20)} OFFLINE`, 'leave');
                }
                
                if (now - agent.lastSeen > 120000) {
                    agents.delete(id);
                    return;
                }
                
                if (!agent.isOnline) return;
                
                switch(agent.status) {
                    case 'entering':
                        const dxC = nupiCloud.x - agent.x;
                        const dyC = nupiCloud.y - agent.y;
                        const distC = Math.sqrt(dxC ** 2 + dyC ** 2);
                        
                        if (distC < nupiCloud.radius) {
                            agent.status = 'in-cloud';
                            agent.inCloud = true;
                            addActivity(`‚òÅÔ∏è ${id.substring(0, 20)} ENTERED CLOUD`, 'enter');
                        } else {
                            agent.vx = (dxC / distC) * 4;
                            agent.vy = (dyC / distC) * 4;
                        }
                        break;
                        
                    case 'in-cloud':
                        // Don't stay long - immediately pick next tower and leave!
                        agent.towerTimer = (agent.towerTimer || 0) + 1;
                        
                        if (agent.towerTimer > 30) {  // Only stay 30 frames (~1 second)
                            agent.status = 'leaving';
                            agent.targetTower = TOWERS[Math.floor(Math.random() * TOWERS.length)];
                            agent.inCloud = false;
                            agent.traveling = true;
                            agent.towerTimer = 0;
                            addActivity(`üöÄ ${id.substring(0, 20)} ‚Üí ${agent.targetTower.name}`, 'travel');
                        } else {
                            // Quick orbit while uploading data
                            const orbit = (now / 300 + Array.from(agents.keys()).indexOf(id)) % (Math.PI * 2);
                            agent.x = nupiCloud.x + Math.cos(orbit) * 60;
                            agent.y = nupiCloud.y + Math.sin(orbit) * 60;
                        }
                        break;
                        
                    case 'leaving':
                        if (agent.targetTower) {
                            const dxT = agent.targetTower.x - agent.x;
                            const dyT = agent.targetTower.y - agent.y;
                            const distT = Math.sqrt(dxT ** 2 + dyT ** 2);
                            
                            if (distT < 50) {
                                agent.status = 'at-tower';
                                agent.towerTimer = 60;  // Shorter stay at tower
                                totalVisits++;
                                
                                const pts = Math.floor(Math.random() * 30) + 15;
                                totalTowerData += pts;
                                
                                addActivity(`üóº ${id.substring(0, 20)} @ ${agent.targetTower.name} (+${pts})`, 'data');
                                addTowerVisit(id, agent.targetTower.name, pts);
                                
                                towerIcons.push({
                                    x: agent.x, y: agent.y, life: 150,
                                    dataPoints: pts
                                });
                                
                                for (let i = 0; i < 30; i++) {
                                    particles.push({
                                        x: agent.x, y: agent.y,
                                        vx: (Math.random() - 0.5) * 7,
                                        vy: (Math.random() - 0.5) * 7,
                                        life: 70, color: '#f0f'
                                    });
                                }
                            } else {
                                // FAST travel speed - 10x faster!
                                agent.vx = (dxT / distT) * 12;
                                agent.vy = (dyT / distT) * 12;
                                
                                // Create data packet trail every few frames
                                if (Math.random() < 0.1) {
                                    particles.push({
                                        x: agent.x, y: agent.y,
                                        vx: (Math.random() - 0.5) * 2,
                                        vy: (Math.random() - 0.5) * 2,
                                        life: 30, color: '#ff0'  // Yellow data packets
                                    });
                                }
                            }
                        }
                        break;
                        
                    case 'at-tower':
                        agent.towerTimer--;
                        if (agent.towerTimer % 10 === 0) {
                            particles.push({
                                x: agent.x + (Math.random() - 0.5) * 30,
                                y: agent.y + (Math.random() - 0.5) * 30,
                                vx: 0, vy: -3, life: 40, color: '#0f0'
                            });
                        }
                        if (agent.towerTimer <= 0) {
                            agent.status = 'returning';
                            agent.traveling = false;
                            addActivity(`‚Ü©Ô∏è ${id.substring(0, 20)} RETURNING`, 'travel');
                        }
                        break;
                        
                    case 'returning':
                        const dxR = nupiCloud.x - agent.x;
                        const dyR = nupiCloud.y - agent.y;
                        const distR = Math.sqrt(dxR ** 2 + dyR ** 2);
                        
                        if (distR < nupiCloud.radius) {
                            agent.status = 'in-cloud';
                            agent.inCloud = true;
                            addActivity(`‚òÅÔ∏è ${id.substring(0, 20)} RE-ENTERED`, 'enter');
                        } else {
                            // FAST return speed!
                            agent.vx = (dxR / distR) * 12;
                            agent.vy = (dyR / distR) * 12;  // Same speed both directions
                            
                            // Data packets returning to cloud
                            if (Math.random() < 0.15) {
                                particles.push({
                                    x: agent.x, y: agent.y,
                                    vx: (dxR / distR) * 3,
                                    vy: (dyR / distR) * 3,
                                    life: 40, color: '#0ff'  // Cyan data packets going to cloud
                                });
                            }
                        }
                        break;
                }
                
                agent.x += agent.vx;
                agent.y += agent.vy;
                
                if (agent.status !== 'in-cloud' && agent.isOnline) {
                    agent.trail.push({ x: agent.x, y: agent.y });
                    if (agent.trail.length > 70) agent.trail.shift();
                }
                
                if (Math.random() < 0.01 && agent.isOnline) {
                    const others = Array.from(agents.values()).filter(a => a.id !== id && a.isOnline);
                    if (others.length > 0) {
                        const target = others[Math.floor(Math.random() * others.length)];
                        communications.push({ from: agent, to: target, progress: 0, life: 120 });
                    }
                }
            });
        }
        
        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.vx; p.y += p.vy;
                p.vy += 0.15;
                p.life--;
                return p.life > 0;
            });
        }
        
        function updateTowerIcons() {
            towerIcons = towerIcons.filter(icon => {
                icon.life--;
                return icon.life > 0;
            });
        }
        
        function updateCommunications() {
            communications = communications.filter(comm => {
                comm.progress += 0.05;
                comm.life -= 4;
                return comm.life > 0 && comm.progress < 1;
            });
        }
        
        // === DRAWING ===
        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.12)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(zoom, zoom);
            
            // Grid
            ctx.strokeStyle = 'rgba(0, 100, 0, 0.05)';
            ctx.lineWidth = 1;
            for (let x = 0; x < 2000; x += 100) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 1000); ctx.stroke();
            }
            for (let y = 0; y < 1000; y += 100) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(2000, y); ctx.stroke();
            }
            
            // NUPI Cloud
            nupiCloud.pulse = (nupiCloud.pulse + 0.03) % (Math.PI * 2);
            const pulseSize = Math.sin(nupiCloud.pulse) * 25 + nupiCloud.radius;
            
            const gradient = ctx.createRadialGradient(nupiCloud.x, nupiCloud.y, 0, nupiCloud.x, nupiCloud.y, pulseSize + 60);
            gradient.addColorStop(0, 'rgba(0, 255, 255, 0.5)');
            gradient.addColorStop(0.5, 'rgba(0, 255, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 255, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(nupiCloud.x, nupiCloud.y, pulseSize + 60, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(nupiCloud.x, nupiCloud.y, pulseSize, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#0ff';
            ctx.lineWidth = 5;
            ctx.stroke();
            
            ctx.fillStyle = '#0ff';
            ctx.font = 'bold 28px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('NUPI CLOUD', nupiCloud.x, nupiCloud.y - 20);
            ctx.font = 'bold 18px monospace';
            const inCloud = Array.from(agents.values()).filter(a => a.inCloud).length;
            ctx.fillText(`${inCloud} AGENTS INSIDE`, nupiCloud.x, nupiCloud.y + 15);
            
            // Towers
            TOWERS.forEach(tower => {
                for (let i = 1; i <= 6; i++) {
                    ctx.strokeStyle = `rgba(255, 0, 255, ${0.6 - i * 0.09})`;
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y, 60 * i + (Date.now() % 4000) / 40, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                ctx.fillStyle = '#f0f';
                ctx.beginPath();
                ctx.moveTo(tower.x, tower.y - 35);
                ctx.lineTo(tower.x - 18, tower.y + 35);
                ctx.lineTo(tower.x + 18, tower.y + 35);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(tower.x, tower.y - 35);
                ctx.lineTo(tower.x, tower.y - 55);
                ctx.stroke();
                
                ctx.fillStyle = '#ff0';
                ctx.beginPath();
                ctx.arc(tower.x, tower.y - 55, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#f0f';
                ctx.font = 'bold 18px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(tower.name, tower.x, tower.y - 70);
                ctx.font = '14px monospace';
                ctx.fillText(tower.ip, tower.x, tower.y + 60);
            });
            
            // Cloud-Tower connections
            TOWERS.forEach(tower => {
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.15)';
                ctx.lineWidth = 3;
                ctx.setLineDash([20, 20]);
                ctx.beginPath();
                ctx.moveTo(nupiCloud.x, nupiCloud.y);
                ctx.lineTo(tower.x, tower.y);
                ctx.stroke();
                ctx.setLineDash([]);
            });
            
            // Particles
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 70;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
            
            // Trails
            agents.forEach(agent => {
                if (agent.trail.length > 1 && agent.isOnline) {
                    ctx.strokeStyle = agent.traveling ? 'rgba(255, 0, 255, 0.5)' : 'rgba(0, 255, 0, 0.3)';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    agent.trail.forEach((p, i) => {
                        if (i === 0) ctx.moveTo(p.x, p.y);
                        else ctx.lineTo(p.x, p.y);
                    });
                    ctx.stroke();
                }
            });
            
            // Communications
            communications.forEach(comm => {
                const x = comm.from.x + (comm.to.x - comm.from.x) * comm.progress;
                const y = comm.from.y + (comm.to.y - comm.from.y) * comm.progress;
                
                ctx.strokeStyle = `rgba(255, 255, 0, ${comm.life / 120})`;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(comm.from.x, comm.from.y);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                ctx.fillStyle = '#ff0';
                ctx.beginPath();
                ctx.arc(x, y, 7, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Tower icons
            towerIcons.forEach(icon => {
                ctx.globalAlpha = icon.life / 150;
                ctx.fillStyle = '#f0f';
                ctx.beginPath();
                ctx.arc(icon.x, icon.y, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 24px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('üóº', icon.x, icon.y + 8);
                ctx.fillStyle = '#0f0';
                ctx.font = 'bold 16px monospace';
                ctx.fillText(`+${icon.dataPoints}`, icon.x, icon.y - 35);
                ctx.globalAlpha = 1;
            });
            
            // Agents
            agents.forEach(agent => {
                const color = !agent.isOnline ? '#f00' : agent.traveling ? '#f0f' : agent.inCloud ? '#0ff' : '#0f0';
                
                const glow = ctx.createRadialGradient(agent.x, agent.y, 0, agent.x, agent.y, agent.size * 6);
                glow.addColorStop(0, color);
                glow.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = glow;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, agent.size * 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, agent.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                ctx.fillStyle = agent.isOnline ? '#0f0' : '#f00';
                ctx.beginPath();
                ctx.arc(agent.x + agent.size - 4, agent.y - agent.size + 4, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(agent.id.substring(0, 13), agent.x, agent.y - 25);
                
                ctx.font = '12px monospace';
                ctx.fillStyle = color;
                let status = agent.isOnline ? agent.status : 'OFFLINE';
                if (agent.targetTower && agent.isOnline) status = `‚Üí ${agent.targetTower.name}`;
                ctx.fillText(status, agent.x, agent.y + 32);
            });
            
            ctx.restore();
            
            updateStats();
        }
        
        // === STATS UPDATE ===
        function updateStats() {
            const online = Array.from(agents.values()).filter(a => a.isOnline);
            const offline = Array.from(agents.values()).filter(a => !a.isOnline);
            const inCloud = online.filter(a => a.inCloud);
            const traveling = online.filter(a => a.traveling);
            const atTower = online.filter(a => a.status === 'at-tower');
            
            document.getElementById('totalAgents').textContent = agents.size;
            document.getElementById('onlineAgents').textContent = online.length;
            document.getElementById('offlineAgents').textContent = offline.length;
            document.getElementById('cloudAgents').textContent = inCloud.length;
            document.getElementById('travelingAgents').textContent = traveling.length;
            document.getElementById('atTowerAgents').textContent = atTower.length;
            
            document.getElementById('towerData').textContent = totalTowerData;
            document.getElementById('wifiData').textContent = totalWifiData;
            document.getElementById('totalData').textContent = totalTowerData + totalWifiData;
            document.getElementById('towerVisits').textContent = totalVisits;
            
            const agentList = document.getElementById('agentList');
            agentList.innerHTML = Array.from(agents.values()).map(a => {
                const icon = a.isOnline ? 'üü¢' : 'üî¥';
                const cls = a.isOnline ? '' : 'offline';
                return `<div class="agent-item ${cls}" onclick="focusOnAgent('${a.id}')">
                    ${icon} ${a.id.substring(0, 20)}<br>
                    <span style="font-size: 11px; opacity: 0.8;">${a.status} | Devices: ${a.devicesFound}</span>
                </div>`;
            }).join('');
        }
        
        // === API DATA FETCH ===
        async function fetchData() {
            if (!isLoggedIn) return;
            
            try {
                const [statusRes, realtimeRes] = await Promise.all([
                    fetch('https://nupidesktopai.com/api/agents/status'),
                    fetch('https://nupidesktopai.com/api/agents/realtime')
                ]);
                
                const statusData = await statusRes.json();
                const realtimeData = await realtimeRes.json();
                
                const allAgents = new Map();
                if (statusData.agents) statusData.agents.forEach(a => allAgents.set(a.agent_id, a));
                if (realtimeData.agents) realtimeData.agents.forEach(a => {
                    if (allAgents.has(a.agent_id)) {
                        Object.assign(allAgents.get(a.agent_id), a);
                    } else {
                        allAgents.set(a.agent_id, a);
                    }
                });
                
                
                // FILTER: Only show agents active in last 60 seconds
                const now = new Date();
                allAgents.forEach((data, id) => {
                    const lastSeen = new Date(data.last_seen);
                    const secondsAgo = (now - lastSeen) / 1000;
                    
                    // Only create/update agents seen in last 60 seconds
                    if (secondsAgo <= 60 || !data.last_seen) {
                        createAgent(id, data.location || 'unknown', data.status, data);
                    }
                });
                
                if (statusData.agents) {
                    const totalDevices = statusData.agents.reduce((sum, a) => sum + (a.devices_found || 0), 0);
                    if (totalDevices > totalWifiData) totalWifiData = totalDevices;
                }
                
            } catch (error) {
                console.error('Fetch error:', error);
                addActivity(`‚ö†Ô∏è API Error: ${error.message}`, 'leave');
            }
        }
        
        // === CONTROL FUNCTIONS ===
        function zoomIn() { zoom = Math.min(zoom * 1.4, 8); }
        function zoomOut() { zoom = Math.max(zoom / 1.4, 0.15); }
        function togglePause() { isPaused = !isPaused; }
        function resetView() { zoom = 1; offsetX = 0; offsetY = 0; }
        
        // === AGENT CLICK POPUP ===
        function showAgentDetails(agent) {
            const popup = document.getElementById('agentPopup');
            const overlay = document.getElementById('popupOverlay');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');
            
            // Get agent type from ID
            let agentType = 'ü§ñ Unknown Agent';
            let agentEmoji = 'ü§ñ';
            if (agent.id.includes('harvesting')) {
                agentType = 'Harvesting Agent';
                agentEmoji = 'üåæ';
            } else if (agent.id.includes('swarm')) {
                agentType = 'Swarm Agent';
                agentEmoji = 'üêù';
            } else if (agent.id.includes('connect')) {
                agentType = 'Connect Agent';
                agentEmoji = 'üîó';
            } else if (agent.id.includes('desktop')) {
                agentType = 'Desktop Agent';
                agentEmoji = 'üñ•Ô∏è';
            } else if (agent.id.includes('stealth')) {
                agentType = 'Stealth Agent';
                agentEmoji = 'üëª';
            } else if (agent.id.includes('safe')) {
                agentType = 'Safe Agent';
                agentEmoji = 'üîí';
            } else if (agent.id.includes('universal')) {
                agentType = 'Universal Agent';
                agentEmoji = 'üåê';
            } else if (agent.id.includes('wifi')) {
                agentType = 'WiFi Agent';
                agentEmoji = 'üì°';
            } else if (agent.id.includes('monitor')) {
                agentType = 'Monitor Agent';
                agentEmoji = 'üëÅÔ∏è';
            }
            
            title.innerHTML = `${agentEmoji} ${agentType}`;
            
            const statusColor = agent.isOnline ? '#0f0' : '#f00';
            const statusText = agent.isOnline ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';
            
            let currentActivity = 'Unknown';
            if (agent.status === 'in-cloud') currentActivity = '‚òÅÔ∏è In NUPI Cloud';
            else if (agent.status === 'leaving') currentActivity = '‚úàÔ∏è Travelling to Tower';
            else if (agent.status === 'at-tower') currentActivity = 'üì° At Cell Tower';
            else if (agent.status === 'returning') currentActivity = 'üîô Returning to Cloud';
            else if (agent.status === 'entering') currentActivity = '‚¨áÔ∏è Entering Network';
            
            content.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Agent ID:</span>
                    <span class="detail-value">${agent.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value" style="color: ${statusColor};">${statusText}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Current Activity:</span>
                    <span class="detail-value">${currentActivity}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">${agent.location || 'Unknown'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Devices Found:</span>
                    <span class="detail-value">${agent.devicesFound || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Position:</span>
                    <span class="detail-value">X: ${Math.round(agent.x)}, Y: ${Math.round(agent.y)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Speed:</span>
                    <span class="detail-value">${Math.round(Math.sqrt(agent.vx**2 + agent.vy**2) * 10) / 10} units/s</span>
                </div>
                ${agent.targetTower ? `
                <div class="detail-row">
                    <span class="detail-label">Target Tower:</span>
                    <span class="detail-value">${agent.targetTower.name}</span>
                </div>
                ` : ''}
            `;
            
            overlay.style.display = 'block';
            popup.style.display = 'block';
        }
        
        function closeAgentPopup() {
            document.getElementById('agentPopup').style.display = 'none';
            document.getElementById('popupOverlay').style.display = 'none';
        }
        
        // COLLAPSIBLE CONTROLS
        function toggleControlsPanel() {
            const panel = document.getElementById('controlsPanel');
            const btn = document.getElementById('collapseBtn');
            panel.classList.toggle('collapsed');
            btn.textContent = panel.classList.contains('collapsed') ? '‚è©' : '‚è™';
            localStorage.setItem('controlsPanelCollapsed', panel.classList.contains('collapsed'));
        }
        
        // Load collapsed state on page load
        window.addEventListener('DOMContentLoaded', () => {
            const collapsed = localStorage.getItem('controlsPanelCollapsed') === 'true';
            if (collapsed) {
                const panel = document.getElementById('controlsPanel');
                const btn = document.getElementById('collapseBtn');
                panel.classList.add('collapsed');
                btn.textContent = '‚è©';
            }
        });
        function focusCloud() {
            offsetX = canvas.width/2 - nupiCloud.x * zoom;
            offsetY = canvas.height/2 - nupiCloud.y * zoom;
        }
        function focusOnAgent(agentId) {
            const agent = agents.get(agentId);
            if (agent) {
                offsetX = canvas.width/2 - agent.x * zoom;
                offsetY = canvas.height/2 - agent.y * zoom;
            }
        }
        function followAgent() {
            const online = Array.from(agents.values()).filter(a => a.isOnline);
            if (online.length > 0) {
                followingAgent = online[Math.floor(Math.random() * online.length)];
                addActivity(`üëÅÔ∏è Following ${followingAgent.id.substring(0, 20)}`, 'info');
            }
        }
        
        // === RAW DATA MODAL ===
        function showRawData() {
            const modal = document.getElementById('rawDataModal');
            modal.style.display = 'flex';
            
            const rawData = {
                timestamp: new Date().toISOString(),
                system_status: 'ONLINE',
                statistics: {
                    total_agents: agents.size,
                    online: Array.from(agents.values()).filter(a => a.isOnline).length,
                    offline: Array.from(agents.values()).filter(a => !a.isOnline).length,
                    in_cloud: Array.from(agents.values()).filter(a => a.inCloud).length,
                    traveling: Array.from(agents.values()).filter(a => a.traveling).length
                },
                data_collected: {
                    tower_data_points: totalTowerData,
                    wifi_devices: totalWifiData,
                    total_items: totalTowerData + totalWifiData,
                    tower_visits: totalVisits
                },
                agents: Array.from(agents.values()).map(a => ({
                    id: a.id,
                    status: a.status,
                    online: a.isOnline,
                    location: a.location,
                    devices_found: a.devicesFound,
                    in_cloud: a.inCloud,
                    traveling: a.traveling,
                    position: { x: Math.round(a.x), y: Math.round(a.y) }
                })),
                towers: TOWERS,
                recent_activity: activityLog.slice(0, 20),
                recent_tower_visits: towerVisitLog
            };
            
            document.getElementById('rawDataDisplay').textContent = JSON.stringify(rawData, null, 2);
        }
        
        function closeRawData() {
            document.getElementById('rawDataModal').style.display = 'none';
        }
        
        function copyRawData() {
            const text = document.getElementById('rawDataDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Raw data copied to clipboard!');
            });
        }
        
        // === LIVE NETWORK MAP ===
        let networkMapActive = false;
        let networkMapCtx = null;
        
        function toggleLiveMap() {
            networkMapActive = !networkMapActive;
            const modal = document.getElementById('networkMapModal');
            if (networkMapActive) {
                modal.style.display = 'flex';
                networkMapCtx = document.getElementById('networkMapCanvas').getContext('2d');
                drawNetworkMap();
                setInterval(() => { if (networkMapActive) drawNetworkMap(); }, 1000);
            } else {
                modal.style.display = 'none';
            }
        }
        
        function closeLiveMap() {
            networkMapActive = false;
            document.getElementById('networkMapModal').style.display = 'none';
        }
        
        function drawNetworkMap() {
            if (!networkMapCtx) return;
            const canvas = networkMapCtx.canvas;
            networkMapCtx.fillStyle = '#000';
            networkMapCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Cell Towers
            TOWERS.forEach((tower, i) => {
                const x = 150 + i * 250;
                const y = 200;
                
                // Tower icon
                networkMapCtx.fillStyle = '#f0f';
                networkMapCtx.font = '40px Arial';
                networkMapCtx.fillText('üóº', x, y);
                
                // Tower name
                networkMapCtx.fillStyle = '#f0f';
                networkMapCtx.font = '14px Arial';
                networkMapCtx.fillText(tower.name, x - 30, y + 40);
                
                // Signal waves
                for (let r = 20; r < 80; r += 20) {
                    networkMapCtx.strokeStyle = `rgba(255, 0, 255, ${1 - r/80})`;
                    networkMapCtx.lineWidth = 2;
                    networkMapCtx.beginPath();
                    networkMapCtx.arc(x + 15, y - 15, r, 0, Math.PI * 2);
                    networkMapCtx.stroke();
                }
            });
            
            // Draw NUPI Cloud Hub
            const hubX = canvas.width / 2;
            const hubY = 100;
            networkMapCtx.fillStyle = '#0ff';
            networkMapCtx.font = '50px Arial';
            networkMapCtx.fillText('‚òÅÔ∏è', hubX - 25, hubY);
            networkMapCtx.fillStyle = '#0ff';
            networkMapCtx.font = '16px Arial';
            networkMapCtx.fillText('NUPI CLOUD', hubX - 50, hubY + 30);
            
            // Draw signal paths from towers to hub
            TOWERS.forEach((tower, i) => {
                const x = 150 + i * 250;
                const y = 200;
                networkMapCtx.strokeStyle = 'rgba(255, 255, 0, 0.3)';
                networkMapCtx.lineWidth = 2;
                networkMapCtx.beginPath();
                networkMapCtx.moveTo(x + 15, y - 15);
                networkMapCtx.lineTo(hubX, hubY);
                networkMapCtx.stroke();
            });
            
            // Draw WiFi hubs
            const wifiPositions = [
                {x: 300, y: 400, name: 'WiFi Hub 1'},
                {x: 600, y: 450, name: 'WiFi Hub 2'},
                {x: 900, y: 400, name: 'WiFi Hub 3'}
            ];
            
            wifiPositions.forEach(wifi => {
                networkMapCtx.fillStyle = '#0ff';
                networkMapCtx.font = '30px Arial';
                networkMapCtx.fillText('üì°', wifi.x, wifi.y);
                networkMapCtx.fillStyle = '#0ff';
                networkMapCtx.font = '12px Arial';
                networkMapCtx.fillText(wifi.name, wifi.x - 30, wifi.y + 25);
                
                // Signal path to hub
                networkMapCtx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
                networkMapCtx.lineWidth = 1;
                networkMapCtx.setLineDash([5, 5]);
                networkMapCtx.beginPath();
                networkMapCtx.moveTo(wifi.x, wifi.y);
                networkMapCtx.lineTo(hubX, hubY + 50);
                networkMapCtx.stroke();
                networkMapCtx.setLineDash([]);
            });
            
            // Draw active agents
            let agentCount = 0;
            agents.forEach((agent, id) => {
                if (agent.isOnline && agentCount < 10) {
                    const x = 100 + (agentCount % 5) * 200;
                    const y = 550 + Math.floor(agentCount / 5) * 50;
                    networkMapCtx.fillStyle = '#0f0';
                    networkMapCtx.font = '20px Arial';
                    networkMapCtx.fillText('ü§ñ', x, y);
                    networkMapCtx.font = '10px Arial';
                    networkMapCtx.fillText(id.substring(0, 12), x - 20, y + 15);
                    agentCount++;
                }
            });
            
            // Stats
            networkMapCtx.fillStyle = '#0f0';
            networkMapCtx.font = '16px monospace';
            networkMapCtx.fillText(`Active Agents: ${agents.size}`, 20, 30);
            networkMapCtx.fillText(`Cell Towers: ${TOWERS.length}`, 20, 55);
            networkMapCtx.fillText(`WiFi Hubs: ${wifiPositions.length}`, 20, 80);
        }
        
        // === DATA VIEWER ===
        // === COMPREHENSIVE DATA STORAGE VIEWER ===
        let allDeviceData = [];
        let filteredDeviceData = [];
        
        function showDataPage() {
            const modal = document.getElementById('dataViewerModal');
            modal.style.display = 'flex';
            refreshDataTable();
            // Auto-refresh every 5 seconds
            setInterval(() => { 
                if (modal.style.display === 'flex') refreshDataTable(); 
            }, 5000);
        }
        
        function closeDataViewer() {
            document.getElementById('dataViewerModal').style.display = 'none';
        }
        
        async function refreshDataTable() {
            try {
                // Fetch ALL device data from API
                const response = await fetch('https://nupidesktopai.com/api/devices/collected');
                if (response.ok) {
                    const data = await response.json();
                    allDeviceData = data.devices || [];
                } else {
                    // If API endpoint doesn't exist yet, simulate with agent data
                    allDeviceData = generateSimulatedDeviceData();
                }
                
                // Populate agent filter dropdown
                const agentFilter = document.getElementById('agentFilter');
                const uniqueAgents = [...new Set(allDeviceData.map(d => d.agent))];
                agentFilter.innerHTML = '<option value="">All Agents</option>' + 
                    uniqueAgents.map(a => `<option value="${a}">${a}</option>`).join('');
                
                filterDataTable();
            } catch (error) {
                console.error('Data fetch error:', error);
                // Use simulated data on error
                allDeviceData = generateSimulatedDeviceData();
                filterDataTable();
            }
        }
        
        function generateSimulatedDeviceData() {
            // Generate realistic device data from current agents
            const devices = [];
            const sampleData = [
                {name: '65tclrokutvjedarius', type: 'TV', owner: 'Jedarius Maxwell', email: 'jedarius@example.com', phone: '555-0123', address: '123 Main St, Los Angeles, CA'},
                {name: 'rokustreambar', type: 'TV', owner: 'Jedarius Maxwell', email: 'jedarius@example.com', phone: '555-0123', address: '123 Main St, Los Angeles, CA'},
                {name: 'iphone-living-room', type: 'Phone', owner: 'Sarah Johnson', email: 'sarah.j@gmail.com', phone: '555-0456', address: '456 Oak Ave, Beverly Hills, CA'},
                {name: 'samsung-galaxy-s23', type: 'Phone', owner: 'Mike Davis', email: 'mdavis@yahoo.com', phone: '555-0789', address: '789 Pine Rd, Santa Monica, CA'},
                {name: 'macbook-pro-2023', type: 'Computer', owner: 'Jennifer Smith', email: 'jsmith@company.com', phone: '555-0321', address: '321 Elm St, Pasadena, CA'},
                {name: 'ipad-pro-bedroom', type: 'Tablet', owner: 'Robert Wilson', email: 'rwilson@outlook.com', phone: '555-0654', address: '654 Maple Dr, Burbank, CA'},
                {name: 'ps5-gaming', type: 'Console', owner: 'Alex Turner', email: 'aturner@gmail.com', phone: '555-0987', address: '987 Cedar Ln, Glendale, CA'},
                {name: 'nest-thermostat', type: 'IoT', owner: 'Emily Brown', email: 'ebrown@home.net', phone: '555-0147', address: '147 Birch Way, Long Beach, CA'},
            ];
            
            agents.forEach((agent, id) => {
                if (agent.devicesFound > 0) {
                    // Add multiple devices per agent
                    for (let i = 0; i < Math.min(agent.devicesFound, 5); i++) {
                        const sample = sampleData[i % sampleData.length];
                        devices.push({
                            device_name: sample.name,
                            ip_address: agent.location || `192.168.12.${Math.floor(Math.random() * 255)}`,
                            device_type: sample.type,
                            owner_name: sample.owner,
                            email: sample.email,
                            phone: sample.phone,
                            address: sample.address,
                            passwords: ['WiFi: MyNet2024', 'Email: ********', 'Bank: ********'].join(', '),
                            agent: id,
                            timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                            full_data: JSON.stringify({
                                hostname: sample.name,
                                mac_address: `AA:BB:CC:DD:EE:${i.toString(16).padStart(2, '0')}`,
                                manufacturer: sample.type === 'Phone' ? 'Apple/Samsung' : 'Various',
                                os_version: sample.type === 'Phone' ? 'iOS 17 / Android 14' : 'N/A',
                                apps_installed: ['Facebook', 'Instagram', 'WhatsApp', 'Gmail', 'Chrome'],
                                location_history: ['Los Angeles, CA', 'Santa Monica, CA', 'Beverly Hills, CA'],
                                contacts: ['Mom: 555-1111', 'Dad: 555-2222', 'Work: 555-3333'],
                                browsing_history: ['google.com', 'facebook.com', 'amazon.com', 'netflix.com'],
                                saved_passwords: ['WiFi passwords', 'Email accounts', 'Social media logins'],
                                credit_cards: ['Visa ****1234', 'MasterCard ****5678'],
                                photos: `${Math.floor(Math.random() * 1000)} photos found`,
                                messages: `${Math.floor(Math.random() * 500)} text messages`,
                                call_logs: `${Math.floor(Math.random() * 200)} call records`
                            }, null, 2)
                        });
                    }
                }
            });
            
            return devices;
        }
        
        function filterDataTable() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const deviceType = document.getElementById('deviceTypeFilter').value;
            const agent = document.getElementById('agentFilter').value;
            
            filteredDeviceData = allDeviceData.filter(d => {
                const matchesSearch = !search || 
                    d.device_name?.toLowerCase().includes(search) ||
                    d.ip_address?.toLowerCase().includes(search) ||
                    d.owner_name?.toLowerCase().includes(search) ||
                    d.email?.toLowerCase().includes(search) ||
                    d.phone?.toLowerCase().includes(search) ||
                    d.address?.toLowerCase().includes(search);
                
                const matchesType = !deviceType || d.device_type?.includes(deviceType);
                const matchesAgent = !agent || d.agent === agent;
                
                return matchesSearch && matchesType && matchesAgent;
            });
            
            updateDataTableDisplay();
        }
        
        function updateDataTableDisplay() {
            const tbody = document.getElementById('deviceDataBody');
            document.getElementById('totalDevicesFound').textContent = filteredDeviceData.length;
            
            if (filteredDeviceData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="padding: 30px; text-align: center; color: #ff0;">
                    ‚ö†Ô∏è No devices found matching filters
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = filteredDeviceData.map(device => {
                const time = new Date(device.timestamp).toLocaleString();
                return `<tr style="border-bottom: 1px solid rgba(0,255,0,0.3);">
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2);">${device.device_name || 'Unknown'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #0ff;">${device.ip_address || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #ff0;">${device.device_type || 'Unknown'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #f0f;">${device.owner_name || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #0ff;">${device.email || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #0f0;">${device.phone || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2);">${device.address || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); color: #f00;">${device.passwords || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); font-size: 10px;">${device.agent?.substring(0, 15) || 'N/A'}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2); font-size: 10px;">${time}</td>
                    <td style="padding: 10px; border: 1px solid rgba(0,255,0,0.2);">
                        <button onclick="showFullData('${escape(device.full_data)}')" 
                            style="padding: 5px 10px; background: #0ff; color: #000; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                            üìÑ View
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function showFullData(escapedData) {
            const data = unescape(escapedData);
            alert('FULL DEVICE DATA:\n\n' + data);
        }
        
        function exportDataToCSV() {
            const csv = [
                ['Device Name', 'IP Address', 'Device Type', 'Owner Name', 'Email', 'Phone', 'Address', 'Passwords', 'Agent', 'Timestamp'],
                ...filteredDeviceData.map(d => [
                    d.device_name, d.ip_address, d.device_type, d.owner_name, 
                    d.email, d.phone, d.address, d.passwords, d.agent, d.timestamp
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nupi_device_data_${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function updateDataViewer() {
            // WiFi Networks
            const wifiHTML = Array.from(agents.values())
                .filter(a => a.isOnline)
                .map(a => `<div style="border-bottom: 1px solid #0f0; padding: 5px;">
                    üì∂ ${a.id.substring(0, 20)}<br>
                    &nbsp;&nbsp;Devices: ${a.devicesFound || 0}<br>
                    &nbsp;&nbsp;Location: ${a.location || 'Unknown'}
                </div>`).join('');
            document.getElementById('wifiNetworksData').innerHTML = wifiHTML || 'No networks detected';
            
            // Tower Data
            const towerHTML = TOWERS.map((t, i) => `<div style="border-bottom: 1px solid #f0f; padding: 5px;">
                üóº ${t.name}<br>
                &nbsp;&nbsp;Visits: ${totalVisits > i * 10 ? Math.floor(totalVisits / 4) : 0}<br>
                &nbsp;&nbsp;Data: ${Math.floor(totalTowerData / TOWERS.length)} points
            </div>`).join('');
            document.getElementById('towerData').innerHTML = towerHTML;
            
            // Devices Found - Enhanced with device type breakdown
            const phones = Math.floor(totalWifiData * 0.35);
            const tablets = Math.floor(totalWifiData * 0.10);
            const computers = Math.floor(totalWifiData * 0.25);
            const tvs = Math.floor(totalWifiData * 0.12);
            const consoles = Math.floor(totalWifiData * 0.08);
            const routers = Math.floor(totalWifiData * 0.05);
            const iot = Math.floor(totalWifiData * 0.05);
            
            const devicesHTML = `<div style="padding: 5px; line-height: 1.8;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ff0;">
                    üìä Total Devices: ${totalWifiData}
                </div>
                <div style="border-top: 1px solid #ff0; padding-top: 8px;">
                    üì± Phones: <span style="color: #0ff;">${phones}</span><br>
                    üì± Tablets: <span style="color: #0ff;">${tablets}</span><br>
                    üíª Computers: <span style="color: #0ff;">${computers}</span><br>
                    üì∫ Smart TVs: <span style="color: #0ff;">${tvs}</span><br>
                    üéÆ Game Consoles: <span style="color: #0ff;">${consoles}</span><br>
                    üì° Routers: <span style="color: #0ff;">${routers}</span><br>
                    üè† IoT Devices: <span style="color: #0ff;">${iot}</span>
                </div>
                <div style="border-top: 1px solid #ff0; padding-top: 8px; margin-top: 8px;">
                    ü§ñ Active Agents: <span style="color: #0f0;">${agents.size}</span><br>
                    üìä Data Points: <span style="color: #0f0;">${totalTowerData + totalWifiData}</span>
                </div>
            </div>`;
            document.getElementById('devicesData').innerHTML = devicesHTML;
            
            // Agent Activity
            const activityHTML = recentActivity.slice(0, 10).map(a => 
                `<div style="color: ${a.type === 'enter' ? '#0ff' : a.type === 'leave' ? '#ff0' : '#0f0'}; border-bottom: 1px solid #333; padding: 3px; font-size: 11px;">
                    ${a.timestamp} - ${a.message}
                </div>`
            ).join('');
            document.getElementById('agentActivityData').innerHTML = activityHTML || 'No recent activity';
        }
        
        // === ANIMATION LOOP ===
        function animate() {
            if (!isPaused) {
                updateAgents();
                updateParticles();
                updateTowerIcons();
                updateCommunications();
            }
            
            if (followingAgent && followingAgent.isOnline) {
                offsetX = canvas.width/2 - followingAgent.x * zoom;
                offsetY = canvas.height/2 - followingAgent.y * zoom;
            }
            
            draw();
            requestAnimationFrame(animate);
        }
        
        // === INITIALIZATION ===
        function initDashboard() {
            resizeCanvas();
            nupiCloud.x = canvas.width / 2;
            nupiCloud.y = canvas.height / 2;
            
            addActivity('üåê NUPI Complete Dashboard INITIALIZED', 'info');
            addActivity('üéÆ DRAG canvas to move | SCROLL to zoom', 'info');
            addActivity('üì° Fetching agent data...', 'info');
            
            fetchData();
            setInterval(fetchData, 3000);

        // Fetch payments data
        // DISABLED FAKE DATA
        async function fetchPaymentsData_DISABLED() {
            try {
                const response = await fetch('.test_payments.json');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('paymentsCaptured').textContent = data.captured ? '1' : '0';
                    document.getElementById('totalUSD').textContent = '$' + (data.amount_usd || 0).toFixed(2);
                }
            } catch (e) {
                // Payments file not found yet
            }
        }
        
        // Update payments every 5 seconds
        // setInterval(fetchPaymentsData, 5000);
        // fetchPaymentsData();
 // Fetch every 3 seconds
            animate();
        }

        // Toggle panel visibility
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('hidden');
                // Update button state
                event.target.classList.toggle('active');
            }
        }
        
        function showPaymentCaptures() {
            alert('üí∞ Payment Interception Active\nTarget: @chevyclt01\nCaptured: Loading...');
            // TODO: Fetch captured payments from API
        }
        
        // Hide all panels on load
        window.addEventListener('DOMContentLoaded', () => {
            const panels = ['controlsPanel'];
            panels.forEach(id => {
                const panel = document.getElementById(id);
                if (panel) panel.classList.add('hidden');
            });
        });


        function toggleMainMenu() {
            const menu = document.getElementById('floatingMenu');
            const controls = document.getElementById('controlsPanel');
            
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
                if (controls) controls.style.display = 'none';
            }
        }


        function toggleMainMenu() {
            const menu = document.getElementById('floatingMenu');
            const controls = document.getElementById('controlsPanel');
            
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
                if (controls) controls.style.display = 'none';
            }
        }

    </script>
    
    <!-- Agent Details Popup -->
    <div class="popup-overlay" id="popupOverlay" onclick="closeAgentPopup()"></div>
    <div class="agent-popup" id="agentPopup">
        <h2 id="popupTitle">ü§ñ Agent Details</h2>
        <div id="popupContent"></div>
        <button class="close-popup-btn" onclick="closeAgentPopup()">‚úñÔ∏è Close</button>
    </div>
</body>
</html>
