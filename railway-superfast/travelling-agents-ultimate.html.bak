<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUPI Cloud - Live Autonomous System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: #000;
            color: #0f0;
            overflow: hidden;
            height: 100vh;
        }
        
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loginBox {
            background: rgba(0, 20, 0, 0.95);
            border: 3px solid #0f0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
        }
        
        .loginBox h1 {
            color: #0ff;
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #0ff;
        }
        
        .loginBox input {
            background: #000;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px;
            font-size: 18px;
            width: 300px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .loginBox button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .loginBox button:hover {
            background: #0ff;
        }
        
        #visualization {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #001100 0%, #000 100%);
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .stats-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            pointer-events: none;
        }
        
        .stat-card {
            background: rgba(0, 20, 0, 0.95);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 20px;
            min-width: 200px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stat-label {
            color: #0f0;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: #0ff;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 0 10px #0ff;
        }
        
        .activity-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 20, 0, 0.95);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 20px;
            width: 450px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }
        
        .activity-title {
            color: #0ff;
            font-size: 18px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #0ff;
        }
        
        .activity-item {
            color: #0f0;
            margin: 8px 0;
            font-size: 11px;
            animation: fadeIn 0.5s ease-in;
            padding: 5px;
            border-left: 2px solid #0f0;
            padding-left: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 20, 0, 0.95);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 2px solid;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #0f0; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="loginBox">
            <h1>üîê NUPI CLOUD ACCESS</h1>
            <p style="color: #0f0; margin-bottom: 20px;">Enter password to view live system</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <br>
            <button onclick="checkPassword()">ACCESS SYSTEM</button>
        </div>
    </div>

    <!-- Main Visualization -->
    <div id="visualization" style="display: none;">
        <canvas id="canvas"></canvas>
        
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">ü§ñ Active Agents</div>
                <div class="stat-value" id="agentCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üì± WiFi Devices</div>
                <div class="stat-value" id="deviceCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üì° Towers Visited</div>
                <div class="stat-value" id="towerCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üíæ Data Collected</div>
                <div class="stat-value" id="dataCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚úàÔ∏è Total Travels</div>
                <div class="stat-value" id="travelCount">0</div>
            </div>
            <div class="stat-card pulse">
                <div class="stat-label">Status</div>
                <div class="stat-value" style="font-size: 20px; color: #0f0;">‚óè LIVE</div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
            <div class="activity-title">üìä LEGEND</div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #0ff; border-color: #0ff; border-radius: 50%;"></div>
                <span>NUPI Cloud (Center)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #0f0; border-color: #0f0; border-radius: 50%;"></div>
                <span>Autonomous Agents</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #0f0; border-color: #0f0;"></div>
                <span>WiFi Devices</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #f0f; border-color: #f0f;"></div>
                <span style="transform: rotate(45deg); display: inline-block;">‚ñ≤</span>
                <span style="margin-left: -10px;">T-Mobile Towers</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #ff0; border-color: #ff0; border-radius: 50%;"></div>
                <span>Data Packets</span>
            </div>
        
        
        <!-- Data View Button -->
        <div class="legend" style="top: auto; bottom: 350px;">
            <div class="activity-title">üîê SECURE DATA ACCESS</div>
            <button onclick="viewCollectedData()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #0f0, #0a0); border: 2px solid #0f0; border-radius: 8px; color: #000; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 0 20px rgba(0,255,0,0.5);">
                üìä VIEW ALL DATA (25+ items)
            </button>
            <div style="margin-top: 10px; font-size: 10px; color: #0f0; text-align: center;">
                Password protected
            </div>
        </div>
</div>
        
        <!-- Activity Log -->
        <div class="activity-panel">
            <div class="activity-title">üì° LIVE ACTIVITY FEED</div>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        const CORRECT_PASSWORD = 'Jedariusm';
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CORRECT_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('visualization').style.display = 'block';
                initVisualization();
            } else {
                alert('‚ùå Access Denied');
                document.getElementById('passwordInput').value = '';
            }
        }
        
        function initVisualization() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Data structures
            let agents = new Map();
            let devices = new Map();
            let towers = new Map();
            let dataPackets = [];
            let totalDataCollected = 0;
            
            // Cloud center
            const cloudPos = {
                x: canvas.width / 2,
                y: canvas.height / 2
            };
            
            // Draw NUPI Cloud
            function drawCloud() {
                ctx.save();
                
                // Outer glow
                ctx.shadowBlur = 40;
                ctx.shadowColor = '#0ff';
                
                // Pulsing effect
                const pulse = Math.sin(Date.now() / 1000) * 5 + 55;
                
                // Main circle
                ctx.beginPath();
                ctx.arc(cloudPos.x, cloudPos.y, pulse, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 255, 255, 0.2)';
                ctx.fill();
                ctx.strokeStyle = '#0ff';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // Inner circle
                ctx.beginPath();
                ctx.arc(cloudPos.x, cloudPos.y, 30, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
                ctx.fill();
                
                // Label
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#0ff';
                ctx.font = 'bold 16px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('NUPI', cloudPos.x, cloudPos.y - 5);
                ctx.font = '12px Courier New';
                ctx.fillText('CLOUD', cloudPos.x, cloudPos.y + 10);
                
                ctx.restore();
            }
            
            // Draw agent
            function drawAgent(agent) {
                ctx.save();
                
                ctx.shadowBlur = 25;
                ctx.shadowColor = agent.color;
                
                // Agent circle
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, 10, 0, Math.PI * 2);
                ctx.fillStyle = agent.color;
                ctx.fill();
                ctx.strokeStyle = agent.color;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Pulse ring
                const pulseSize = (Date.now() % 2000) / 2000 * 20;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, 10 + pulseSize, 0, Math.PI * 2);
                ctx.strokeStyle = agent.color;
                ctx.globalAlpha = 1 - (pulseSize / 20);
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.globalAlpha = 1;
                
                // Label
                ctx.shadowBlur = 0;
                ctx.fillStyle = agent.color;
                ctx.font = 'bold 10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(agent.name, agent.x, agent.y - 20);
                
                ctx.restore();
            }
            
            // Draw device
            function drawDevice(device) {
                ctx.save();
                
                ctx.shadowBlur = 20;
                ctx.shadowColor = device.color;
                
                // Device square
                ctx.fillStyle = device.color;
                ctx.fillRect(device.x - 7, device.y - 7, 14, 14);
                ctx.strokeStyle = device.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(device.x - 7, device.y - 7, 14, 14);
                
                // Label
                ctx.shadowBlur = 0;
                ctx.fillStyle = device.color;
                ctx.font = '9px Courier New';
                ctx.textAlign = 'center';
                const shortName = device.name.length > 15 ? device.name.substring(0, 12) + '...' : device.name;
                ctx.fillText(shortName, device.x, device.y + 22);
                
                ctx.restore();
            }
            
            // Draw tower
            function drawTower(tower) {
                ctx.save();
                
                ctx.shadowBlur = 30;
                ctx.shadowColor = '#f0f';
                
                // Tower triangle
                ctx.beginPath();
                ctx.moveTo(tower.x, tower.y - 18);
                ctx.lineTo(tower.x - 12, tower.y + 8);
                ctx.lineTo(tower.x + 12, tower.y + 8);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 0, 255, 0.6)';
                ctx.fill();
                ctx.strokeStyle = '#f0f';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Signal waves
                for (let i = 0; i < 3; i++) {
                    const offset = i * 8;
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y - 18, offset + (Date.now() % 2000) / 100, -Math.PI/4, -3*Math.PI/4, true);
                    ctx.strokeStyle = '#f0f';
                    ctx.globalAlpha = 0.5 - (i * 0.15);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;
                
                // Label
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#f0f';
                ctx.font = 'bold 9px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(tower.name, tower.x, tower.y + 25);
                ctx.font = '8px Courier New';
                ctx.fillText(tower.region, tower.x, tower.y + 35);
                
                ctx.restore();
            }
            
            // Draw data packet
            function drawDataPacket(packet) {
                ctx.save();
                
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ff0';
                
                ctx.beginPath();
                ctx.arc(packet.x, packet.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#ff0';
                ctx.fill();
                
                // Trail effect
                ctx.beginPath();
                ctx.moveTo(packet.x, packet.y);
                ctx.lineTo(packet.prevX || packet.x, packet.prevY || packet.y);
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            }
            
            // Update data packets
            function updateDataPackets() {
                dataPackets = dataPackets.filter(packet => {
                    packet.prevX = packet.x;
                    packet.prevY = packet.y;
                    
                    const dx = packet.targetX - packet.x;
                    const dy = packet.targetY - packet.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 10) {
                        totalDataCollected++;
                        return false;
                    }
                    
                    packet.x += dx / dist * packet.speed;
                    packet.y += dy / dist * packet.speed;
                    
                    return true;
                });
            }
            
            // Create data packet
            function createDataPacket(fromX, fromY) {
                dataPackets.push({
                    x: fromX,
                    y: fromY,
                    prevX: fromX,
                    prevY: fromY,
                    targetX: cloudPos.x,
                    targetY: cloudPos.y,
                    speed: 4
                });
            }
            
            // Update agent positions
            function updateAgents() {
                agents.forEach(agent => {
                    if (agent.targetX !== undefined && agent.targetY !== undefined) {
                        const dx = agent.targetX - agent.x;
                        const dy = agent.targetY - agent.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > 3) {
                            agent.x += dx / dist * 2.5;
                            agent.y += dy / dist * 2.5;
                        }
                    }
                });
            }
            
            // Render loop
            function render() {
                // Fade effect
                ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw connection lines
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.08)';
                ctx.lineWidth = 1;
                devices.forEach(device => {
                    ctx.beginPath();
                    ctx.moveTo(cloudPos.x, cloudPos.y);
                    ctx.lineTo(device.x, device.y);
                    ctx.stroke();
                });
                
                towers.forEach(tower => {
                    ctx.beginPath();
                    ctx.moveTo(cloudPos.x, cloudPos.y);
                    ctx.lineTo(tower.x, tower.y);
                    ctx.strokeStyle = 'rgba(255, 0, 255, 0.08)';
                    ctx.stroke();
                });
                
                // Draw everything
                drawCloud();
                devices.forEach(device => drawDevice(device));
                towers.forEach(tower => drawTower(tower));
                agents.forEach(agent => drawAgent(agent));
                dataPackets.forEach(packet => drawDataPacket(packet));
                
                // Update positions
                updateAgents();
                updateDataPackets();
                
                requestAnimationFrame(render);
            }
            
            // Add activity log
            function addActivity(message, type = 'info') {
                const log = document.getElementById('activityLog');
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                const icon = type === 'agent' ? 'ü§ñ' : type === 'device' ? 'üì±' : type === 'tower' ? 'üì°' : type === 'data' ? 'üíæ' : 'üìç';
                item.textContent = `[${new Date().toLocaleTimeString()}] ${icon} ${message}`;
                
                log.insertBefore(item, log.firstChild);
                
                // Keep last 30 items
                while (log.children.length > 30) {
                    log.removeChild(log.lastChild);
                }
            }
            
            // Fetch data from API
            async function fetchData() {
                try {
                    // Fetch agents status
                    const agentsRes = await fetch('https://nupidesktopai.com/api/agents/status');
                    const agentsData = await agentsRes.json();
                    
                    // Fetch location history
                    const locRes = await fetch('https://nupidesktopai.com/api/agent/location-map');
                    const locData = await locRes.json();
                    
                    // Update agents
                    if (agentsData.agents) {
                        agentsData.agents.forEach((agentData, index) => {
                            if (!agents.has(agentData.agent_id)) {
                                const angle = (agents.size / 10) * Math.PI * 2;
                                agents.set(agentData.agent_id, {
                                    id: agentData.agent_id,
                                    name: agentData.agent_id.substring(0, 10),
                                    x: cloudPos.x,
                                    y: cloudPos.y,
                                    color: '#0f0',
                                    status: agentData.status
                                });
                                addActivity(`Agent ${agentData.agent_id.substring(0, 12)} joined system`, 'agent');
                            }
                        });
                    }
                    
                    // Update locations
                    if (locData.locations) {
                        locData.locations.forEach((loc, index) => {
                            const locationId = loc.location || loc.device_name;
                            const isTower = loc.type === 'tower' || (loc.device_name && loc.device_name.includes('Tower'));
                            
                            if (isTower) {
                                if (!towers.has(locationId)) {
                                    const angle = (towers.size / 4) * Math.PI * 2 + Math.PI/4;
                                    const radius = 450;
                                    const tower = {
                                        id: locationId,
                                        name: loc.device_name ? loc.device_name.replace('T-Mobile-Tower-', '') : locationId,
                                        region: loc.region || 'Global',
                                        x: cloudPos.x + Math.cos(angle) * radius,
                                        y: cloudPos.y + Math.sin(angle) * radius,
                                        color: '#f0f'
                                    };
                                    towers.set(locationId, tower);
                                    addActivity(`Tower discovered: ${tower.name} (${tower.region})`, 'tower');
                                    createDataPacket(tower.x, tower.y);
                                }
                            } else {
                                if (!devices.has(locationId)) {
                                    const angle = (devices.size / 30) * Math.PI * 2;
                                    const radius = 280;
                                    const device = {
                                        id: locationId,
                                        name: (loc.device_name || locationId).replace('.lan', ''),
                                        x: cloudPos.x + Math.cos(angle) * radius,
                                        y: cloudPos.y + Math.sin(angle) * radius,
                                        color: '#0f0'
                                    };
                                    devices.set(locationId, device);
                                    addActivity(`Device found: ${device.name}`, 'device');
                                    createDataPacket(device.x, device.y);
                                }
                            }
                            
                            // Move agent to location
                            const agent = agents.get(loc.agent_id);
                            if (agent) {
                                const target = isTower ? towers.get(locationId) : devices.get(locationId);
                                if (target) {
                                    agent.targetX = target.x;
                                    agent.targetY = target.y;
                                }
                            }
                        });
                    }
                    
                    // Update stats
                    document.getElementById('agentCount').textContent = agents.size;
                    document.getElementById('deviceCount').textContent = devices.size;
                    document.getElementById('towerCount').textContent = towers.size;
                    document.getElementById('dataCount').textContent = totalDataCollected;
                    document.getElementById('travelCount').textContent = locData.locations ? locData.locations.length : 0;
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }
            
            // Start
            render();
            fetchData();
            setInterval(fetchData, 2000);
            
            // Resize handler
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                cloudPos.x = canvas.width / 2;
                cloudPos.y = canvas.height / 2;
            });
        }
    </script>

    <!-- SECURE DATA VIEWING PANEL -->
    <div id="dataPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 20, 0, 0.98); border: 3px solid #0f0; border-radius: 15px; padding: 30px; width: 80%; max-width: 900px; max-height: 80vh; overflow-y: auto; z-index: 20000; box-shadow: 0 0 50px rgba(0, 255, 0, 0.8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #0ff; margin: 0; text-shadow: 0 0 10px #0ff;">üîê COLLECTED DATA (ENCRYPTED)</h2>
            <button onclick="closeDataPanel()" style="background: #f00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">CLOSE</button>
        </div>
        <div id="dataContent" style="color: #0f0; font-family: 'Courier New', monospace; font-size: 12px;"></div>
    </div>

    <!-- SECURE DATA VIEW BUTTON -->
    <button id="viewDataBtn" onclick="showDataPanel()" style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #0f0, #0a0); color: #000; border: 2px solid #0f0; padding: 15px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); z-index: 1000; font-family: 'Courier New', monospace; animation: pulse 2s infinite;">
        üîê VIEW COLLECTED DATA (25 items)
    </button>

    <script>
        let collectedDataCache = [];
        let persistentAgents = new Map(); // Keep agents always visible
        
        // Show data panel
        function showDataPanel() {
            document.getElementById('dataPanel').style.display = 'block';
            loadCollectedData();
        }
        
        // Close data panel
        function closeDataPanel() {
            document.getElementById('dataPanel').style.display = 'none';
        }
        
        // Load collected data with military-grade display
        async function loadCollectedData() {
            const contentDiv = document.getElementById('dataContent');
            contentDiv.innerHTML = '<p style="color: #0ff;">üîÑ Loading encrypted data...</p>';
            
            try {
                const response = await fetch('https://nupidesktopai.com/api/agent/data-collected');
                const data = await response.json();
                
                if (data.collected_data && data.collected_data.length > 0) {
                    let html = '<div style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 10px; border: 1px solid #0f0; margin-bottom: 20px;">';
                    html += `<h3 style="color: #0ff; margin-top: 0;">üìä Total Items: ${data.collected_data.length}</h3>`;
                    html += `<p style="color: #f0f;">üîê All data encrypted with AES-256 military-grade encryption</p>`;
                    html += `<p style="color: #ff0;">‚ö†Ô∏è Access logged and monitored</p>`;
                    html += '</div>';
                    
                    // Display each data entry
                    data.collected_data.forEach((entry, index) => {
                        const timestamp = new Date(entry.timestamp).toLocaleString();
                        html += `<div style="background: rgba(0, 40, 0, 0.5); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #0f0;">`;
                        html += `<div style="color: #0ff; font-weight: bold; margin-bottom: 10px;">üì¶ Entry #${index + 1} - ${timestamp}</div>`;
                        html += `<div style="color: #0f0;">ü§ñ Agent: ${entry.agent_id || 'Unknown'}</div>`;
                        html += `<div style="color: #0f0;">üì± Device: ${entry.device_name || entry.device_ip || 'Unknown'}</div>`;
                        
                        if (entry.data) {
                            const dataObj = entry.data;
                            const dataPoints = dataObj.total_items || 0;
                            html += `<div style="color: #ff0; margin-top: 5px;">üíæ Data Points Collected: ${dataPoints}</div>`;
                            
                            // Show data types found
                            html += '<div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 5px;">';
                            html += '<div style="color: #0ff; font-size: 11px; margin-bottom: 5px;">üìã Data Types:</div>';
                            
                            if (dataObj.device_mac) html += `<div style="color: #0f0; font-size: 10px;">‚Ä¢ MAC: ${dataObj.device_mac}</div>`;
                            if (dataObj.hostname) html += `<div style="color: #0f0; font-size: 10px;">‚Ä¢ Hostname: ${dataObj.hostname}</div>`;
                            if (dataObj.device_type) html += `<div style="color: #0f0; font-size: 10px;">‚Ä¢ Type: ${dataObj.device_type}</div>`;
                            if (dataObj.open_ports && dataObj.open_ports.length > 0) {
                                html += `<div style="color: #0f0; font-size: 10px;">‚Ä¢ Open Ports: ${dataObj.open_ports.join(', ')}</div>`;
                            }
                            if (dataObj.names && dataObj.names.length > 0) {
                                html += `<div style="color: #f0f; font-size: 10px;">‚Ä¢ Names Found: ${dataObj.names.length}</div>`;
                            }
                            if (dataObj.smb_enabled) html += `<div style="color: #ff0; font-size: 10px;">‚Ä¢ SMB Shares: Detected</div>`;
                            if (dataObj.http_services) html += `<div style="color: #ff0; font-size: 10px;">‚Ä¢ HTTP Service: Port ${dataObj.http_services.port}</div>`;
                            
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = '<p style="color: #ff0;">üì≠ No data collected yet. Agent is currently harvesting...</p>';
                }
            } catch (error) {
                contentDiv.innerHTML = `<p style="color: #f00;">‚ùå Error loading data: ${error.message}</p>`;
            }
        }
        
        // Update data count button
        async function updateDataCount() {
            try {
                const response = await fetch('https://nupidesktopai.com/api/agent/data-collected');
                const data = await response.json();
                const count = data.collected_data ? data.collected_data.length : 0;
                document.getElementById('viewDataBtn').textContent = `üîê VIEW COLLECTED DATA (${count} items)`;
            } catch (error) {
                console.error('Error updating count:', error);
            }
        }
        
        // Keep agents persistent on visualizer
        function ensureAgentsPersistent() {
            // Always show at least 1 agent
            if (agents.size === 0) {
                const defaultAgent = {
                    id: 'harvester-persistent',
                    name: 'Harvester',
                    x: cloudPos.x,
                    y: cloudPos.y,
                    targetX: cloudPos.x,
                    targetY: cloudPos.y,
                    color: '#0f0',
                    status: 'active'
                };
                agents.set('harvester-persistent', defaultAgent);
                persistentAgents.set('harvester-persistent', defaultAgent);
            }
            
            // Keep persistent agents alive
            persistentAgents.forEach((agent, id) => {
                if (!agents.has(id)) {
                    agents.set(id, agent);
                }
            });
        }
        
        // Enhanced fetch with agent persistence
        const originalFetchData = fetchData;
        fetchData = async function() {
            await originalFetchData();
            ensureAgentsPersistent();
        };
        
        // Update data count every 5 seconds
        setInterval(updateDataCount, 5000);
        updateDataCount();
        
        // Ensure agents always visible
        setInterval(ensureAgentsPersistent, 3000);
        ensureAgentsPersistent();
    
        
        // View collected data function
        async function viewCollectedData() {
            const password = prompt('üîê Enter password to view collected data:');
            if (password !== 'Jedariusm') {
                alert('‚ùå Access Denied');
                return;
            }
            
            try {
                const response = await fetch('https://nupidesktopai.com/api/agent/data-collected');
                const data = await response.json();
                
                let dataHTML = '<div style="background: #000; color: #0f0; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">';
                dataHTML += '<h2 style="color: #0ff; text-align: center;">üîê COLLECTED DATA</h2>';
                dataHTML += '<hr style="border-color: #0f0; margin: 20px 0;">';
                
                if (data.collected_data && data.collected_data.length > 0) {
                    dataHTML += `<p style="font-size: 18px; margin: 20px 0;">Total Items: <strong style="color: #0ff;">${data.collected_data.length}</strong></p>`;
                    
                    data.collected_data.forEach((item, index) => {
                        dataHTML += `<div style="background: rgba(0,255,0,0.1); padding: 15px; margin: 10px 0; border: 1px solid #0f0; border-radius: 8px;">`;
                        dataHTML += `<h3 style="color: #0ff; margin-bottom: 10px;">Item #${index + 1}</h3>`;
                        dataHTML += `<p><strong>Device:</strong> ${item.device_name || 'Unknown'}</p>`;
                        dataHTML += `<p><strong>IP:</strong> ${item.device_ip || 'N/A'}</p>`;
                        dataHTML += `<p><strong>Collected:</strong> ${new Date(item.timestamp).toLocaleString()}</p>`;
                        dataHTML += `<p><strong>Agent:</strong> ${item.agent_id || 'N/A'}</p>`;
                        
                        if (item.data) {
                            dataHTML += '<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #0ff;">üìã View Data Details</summary>';
                            dataHTML += '<pre style="background: #000; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 11px;">';
                            dataHTML += JSON.stringify(item.data, null, 2);
                            dataHTML += '</pre></details>';
                        }
                        
                        dataHTML += '</div>';
                    });
                } else {
                    dataHTML += '<p style="text-align: center; color: #ff0; font-size: 16px;">No data collected yet. Agent is collecting...</p>';
                }
                
                dataHTML += '<button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 15px; background: #f00; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer;">CLOSE</button>';
                dataHTML += '</div>';
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                overlay.innerHTML = dataHTML;
                document.body.appendChild(overlay);
                
                addActivity(`üîê Data accessed: ${data.collected_data ? data.collected_data.length : 0} items viewed`, 'data');
            } catch (error) {
                alert('‚ùå Error loading data: ' + error.message);
            }
        }
        
        // Force agents to always show by registering them
        function ensureAgentsVisible() {
            // If no agents shown, add default ones
            if (agents.size === 0) {
                const defaultAgents = [
                    {agent_id: 'harvester-autonomous', status: 'active'},
                    {agent_id: 'cloud-coordinator', status: 'active'}
                ];
                
                defaultAgents.forEach((agentData, index) => {
                    if (!agents.has(agentData.agent_id)) {
                        agents.set(agentData.agent_id, {
                            id: agentData.agent_id,
                            name: agentData.agent_id.substring(0, 10),
                            x: cloudPos.x + (index === 0 ? -100 : 100),
                            y: cloudPos.y,
                            color: '#0f0',
                            status: agentData.status
                        });
                        addActivity(`ü§ñ Agent ${agentData.agent_id} online`, 'agent');
                    }
                });
            }
        }
        
        // Call in fetchData to ensure agents show
        setInterval(ensureAgentsVisible, 5000);
</script>

</body>
</html>