<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUPI Agent Tracker - REAL TIME</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #00ff41, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            background: rgba(255, 51, 102, 0.2);
            border-radius: 20px;
            margin-top: 10px;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #ff3366;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            margin: -10px -10px 15px -10px;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .card-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .card-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s;
            opacity: 1;
        }

        .collapsed .card-content {
            max-height: 0;
            opacity: 0;
        }

        .network-viz {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            position: relative;
            min-height: 400px;
            overflow: hidden;
        }

        .agent-item {
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.1), rgba(0, 212, 255, 0.1));
            border-left: 3px solid #00ff41;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .agent-item:hover {
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        .agent-id {
            font-weight: bold;
            color: #00ff41;
            margin-bottom: 8px;
        }

        .agent-action {
            color: #00d4ff;
            font-size: 0.95rem;
            margin: 5px 0;
        }

        .agent-target {
            color: #ffaa00;
            font-family: monospace;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #00d4ff;
        }

        .device-ip {
            font-family: monospace;
            color: #00d4ff;
            font-weight: bold;
        }

        .device-type {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 255, 65, 0.2);
            border-radius: 15px;
            font-size: 0.85rem;
            color: #00ff41;
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
        }

        .agent-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00ff41;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff41;
            transition: all 0.5s ease;
            z-index: 10;
        }

        .agent-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff41;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            transform: translate(-50%, -200%);
        }

        .device-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #00d4ff;
            border-radius: 50%;
            box-shadow: 0 0 8px #00d4ff;
        }

        .timestamp {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .network-label {
            font-size: 1.2rem;
            color: #00ff41;
            text-align: center;
            margin-bottom: 15px;
            font-family: monospace;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ NUPI AGENT TRACKER</h1>
            <p>Real-Time Agent Position & Device Monitoring - NO FAKE DATA</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE - Updates every 3 seconds</span>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                <div class="card-title">
                    üìä Network Statistics
                </div>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="card-content">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats populated by JS -->
                </div>
                <div class="timestamp" id="statsTimestamp"></div>
            </div>
        </div>

        <div class="grid">
            <!-- Active Agents Card -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-title">
                        ü§ñ Active Agents (<span id="agentCount">0</span>)
                    </div>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="card-content">
                    <div id="agentsList">
                        <div class="no-data">Waiting for agents...</div>
                    </div>
                </div>
            </div>

            <!-- Network Status Card -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-title">
                        üåê Network Status
                    </div>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="network-label" id="networkLabel">192.168.12.x</div>
                    <div id="networkStatus">
                        <div class="no-data">Loading network data...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Visualization -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                <div class="card-title">
                    üó∫Ô∏è Live Network Map - LOCAL NETWORK ONLY
                </div>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="card-content">
                <div class="network-viz" id="networkViz">
                    <!-- Agents and devices visualized here -->
                </div>
            </div>
        </div>

        <!-- Devices Card -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                <div class="card-title">
                    üì± Discovered Devices (<span id="deviceCount">0</span>)
                </div>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="card-content">
                <div id="devicesList">
                    <div class="no-data">No devices discovered yet...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load collapsed state from localStorage
        function loadCollapsedStates() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                const key = `card-collapsed-${index}`;
                const isCollapsed = localStorage.getItem(key) === 'true';
                if (isCollapsed) {
                    card.classList.add('collapsed');
                }
            });
        }

        // Toggle card collapse
        function toggleCard(header) {
            const card = header.closest('.card');
            const cards = Array.from(document.querySelectorAll('.card'));
            const index = cards.indexOf(card);
            const key = `card-collapsed-${index}`;
            
            card.classList.toggle('collapsed');
            localStorage.setItem(key, card.classList.contains('collapsed'));
        }

        // Fetch REAL agent data
        async function fetchAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                return data.agents || [];
            } catch (e) {
                console.error('Failed to fetch agents:', e);
                return [];
            }
        }

        // Fetch REAL device data
        async function fetchDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                return data;
            } catch (e) {
                console.error('Failed to fetch devices:', e);
                return { devices: [], total_devices: 0 };
            }
        }

        // Fetch stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                return await response.json();
            } catch (e) {
                console.error('Failed to fetch stats:', e);
                return {};
            }
        }

        // Update stats display
        function updateStats(stats) {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = `
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.total_devices || 0}</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.active_agents || 0}</div>
                    <div class="stat-label">Active Agents</div>
                </div>
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.rokus || 0}</div>
                    <div class="stat-label">Roku TVs</div>
                </div>
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.computers || 0}</div>
                    <div class="stat-label">Computers</div>
                </div>
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.phones || 0}</div>
                    <div class="stat-label">Phones/Tablets</div>
                </div>
                <div class="stat-box fade-in">
                    <div class="stat-value">${stats.total_open_ports || 0}</div>
                    <div class="stat-label">Open Ports</div>
                </div>
            `;
            
            const timestamp = document.getElementById('statsTimestamp');
            timestamp.textContent = `Last updated: ${new Date(stats.last_scan || Date.now()).toLocaleString()}`;
        }

        // Update agents display
        function updateAgents(agents) {
            const list = document.getElementById('agentsList');
            const count = document.getElementById('agentCount');
            
            count.textContent = agents.length;
            
            if (agents.length === 0) {
                list.innerHTML = '<div class="no-data">No active agents</div>';
                return;
            }
            
            list.innerHTML = agents.map(agent => `
                <div class="agent-item fade-in">
                    <div class="agent-id">${agent.agent_id}</div>
                    <div class="agent-action">
                        <strong>Type:</strong> ${agent.agent_type || 'Unknown'}
                    </div>
                    <div class="agent-action">
                        <strong>Action:</strong> ${agent.action || 'Idle'}
                    </div>
                    ${agent.target_ip ? `
                        <div class="agent-action">
                            <strong>Target:</strong> <span class="agent-target">${agent.target_ip}</span>
                        </div>
                    ` : ''}
                    <div class="timestamp">
                        Updated: ${new Date(agent.timestamp).toLocaleTimeString()}
                    </div>
                </div>
            `).join('');
        }

        // Update devices display
        function updateDevices(deviceData) {
            const list = document.getElementById('devicesList');
            const count = document.getElementById('deviceCount');
            const devices = deviceData.devices || [];
            
            count.textContent = devices.length;
            
            if (devices.length === 0) {
                list.innerHTML = '<div class="no-data">No devices discovered</div>';
                return;
            }
            
            list.innerHTML = devices.map(device => `
                <div class="device-item fade-in">
                    <span class="device-ip">${device.ip}</span>
                    <span class="device-type">${device.device_type || 'Unknown'}</span>
                    <div style="margin-top: 8px; font-size: 0.9rem;">
                        <div><strong>Hostname:</strong> ${device.hostname || 'Unknown'}</div>
                        ${device.mac ? `<div><strong>MAC:</strong> ${device.mac}</div>` : ''}
                        ${device.open_ports && device.open_ports.length > 0 ? `
                            <div><strong>Open Ports:</strong> ${device.open_ports.map(p => `${p.port}/${p.service}`).join(', ')}</div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Update network visualization
        function updateNetworkViz(agents, devices) {
            const viz = document.getElementById('networkViz');
            
            // Clear previous dots
            viz.innerHTML = '';
            
            // Draw agent dots with REAL positions
            agents.forEach(agent => {
                const pos = agent.position || { x: 400, y: 300 };
                
                const dot = document.createElement('div');
                dot.className = 'agent-dot fade-in';
                dot.style.left = `${pos.x}px`;
                dot.style.top = `${pos.y}px`;
                
                const label = document.createElement('div');
                label.className = 'agent-label';
                label.textContent = agent.agent_id;
                label.style.left = `${pos.x}px`;
                label.style.top = `${pos.y}px`;
                
                viz.appendChild(dot);
                viz.appendChild(label);
            });
            
            // Draw device dots (fixed positions based on IP)
            if (devices && devices.length > 0) {
                devices.forEach(device => {
                    const lastOctet = parseInt(device.ip.split('.')[3]);
                    const x = 50 + (lastOctet * 2.5) % 700;
                    const y = 350;
                    
                    const dot = document.createElement('div');
                    dot.className = 'device-dot fade-in';
                    dot.style.left = `${x}px`;
                    dot.style.top = `${y}px`;
                    dot.title = `${device.ip} - ${device.hostname}`;
                    
                    viz.appendChild(dot);
                });
            }
        }

        // Main update function - NO FAKE DATA, ONLY REAL API CALLS
        async function updateAll() {
            const [agents, deviceData, stats] = await Promise.all([
                fetchAgents(),
                fetchDevices(),
                fetchStats()
            ]);
            
            updateStats(stats);
            updateAgents(agents);
            updateDevices(deviceData);
            updateNetworkViz(agents, deviceData.devices || []);
            
            document.getElementById('networkLabel').textContent = deviceData.network || '192.168.12.x';
            document.getElementById('networkStatus').innerHTML = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>Network:</strong> ${deviceData.network || '192.168.12.x'}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Last Scan:</strong> ${new Date(deviceData.scan_time || Date.now()).toLocaleString()}
                    </div>
                    <div>
                        <strong>Status:</strong> <span style="color: #00ff41;">‚óè Active</span>
                    </div>
                </div>
            `;
        }

        // Initialize
        loadCollapsedStates();
        updateAll();
        
        // Update every 3 seconds - REAL DATA ONLY
        setInterval(updateAll, 3000);
        
        console.log('ü§ñ NUPI Agent Tracker initialized - REAL DATA MODE');
        console.log('üì° Fetching from REAL API endpoints:');
        console.log('   - /api/agents (agent positions)');
        console.log('   - /api/devices (device data)');
        console.log('   - /api/stats (statistics)');
        console.log('üö´ NO FAKE ANIMATIONS - ALL DATA IS REAL');
    </script>
</body>
</html>
