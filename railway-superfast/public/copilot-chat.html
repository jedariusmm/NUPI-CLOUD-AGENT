<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUPI AI Assistant - GitHub Copilot Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        /* Top Bar */
        .top-bar {
            background: #252526;
            border-bottom: 1px solid #3c3c3c;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-arrow {
            color: #cccccc;
            cursor: pointer;
            font-size: 18px;
        }

        .back-arrow:hover {
            color: #ffffff;
        }

        .search-box {
            background: #3c3c3c;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 6px 12px;
            width: 300px;
            color: #cccccc;
            font-size: 13px;
        }

        .search-box:focus {
            outline: none;
            border-color: #007acc;
        }

        .top-bar-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .icon-button {
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 6px;
            font-size: 16px;
            border-radius: 4px;
        }

        .icon-button:hover {
            background: #3c3c3c;
        }

        /* Right Sidebar - Chat */
        .chat-sidebar {
            width: 450px;
            background: #252526;
            border-left: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Chat Header */
        .chat-header {
            background: #2d2d30;
            padding: 12px 16px;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        /* Todo List Section */
        .todo-section {
            background: #1e1e1e;
            border-bottom: 1px solid #3c3c3c;
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background: #252526;
        }

        .todo-header:hover {
            background: #2d2d30;
        }

        .todo-title {
            font-size: 12px;
            font-weight: 600;
            color: #cccccc;
        }

        .todo-stats {
            font-size: 11px;
            color: #858585;
        }

        .todo-list {
            padding: 8px 16px;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
            color: #cccccc;
        }

        .todo-checkbox {
            margin-top: 2px;
            cursor: pointer;
            accent-color: #007acc;
        }

        .todo-item.completed {
            text-decoration: line-through;
            color: #858585;
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-content {
            flex: 1;
            font-size: 13px;
            line-height: 1.6;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .message-author {
            font-weight: 600;
            color: #ffffff;
            font-size: 12px;
        }

        .message-time {
            font-size: 11px;
            color: #858585;
        }

        .message-text {
            color: #cccccc;
        }

        .message-text code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #d4d4d4;
        }

        .message-text pre {
            background: #1e1e1e;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            border-left: 3px solid #007acc;
        }

        .message-text pre code {
            background: none;
            padding: 0;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007acc;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Attachments */
        .attachments {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .attachment {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attachment:hover {
            border-color: #007acc;
            background: #2d2d30;
        }

        .attachment i {
            color: #007acc;
        }

        /* Chat Input */
        .chat-input-container {
            border-top: 1px solid #3c3c3c;
            padding: 16px;
            background: #252526;
        }

        .input-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .toolbar-button {
            background: transparent;
            border: 1px solid #3c3c3c;
            color: #cccccc;
            cursor: pointer;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .toolbar-button:hover {
            background: #3c3c3c;
            border-color: #007acc;
        }

        .chat-input-wrapper {
            position: relative;
        }

        .chat-input {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 12px 50px 12px 12px;
            color: #cccccc;
            font-size: 13px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
            max-height: 200px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .chat-input::placeholder {
            color: #858585;
        }

        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: #007acc;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-button:hover {
            background: #005a9e;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Agent Status */
        .agent-status {
            background: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            padding: 12px 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .agent-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ec9b0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-dot.busy {
            background: #ce9178;
        }

        .agent-info {
            color: #858585;
        }

        .agent-count {
            color: #4ec9b0;
            font-weight: 600;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* Model Selector */
        .model-selector {
            background: #3c3c3c;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 6px 12px;
            color: #cccccc;
            font-size: 12px;
            cursor: pointer;
        }

        .model-selector:hover {
            border-color: #007acc;
        }

        /* Context Badge */
        .context-badge {
            background: #007acc;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Thinking Animation */
        .thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            color: #858585;
            font-size: 12px;
            font-style: italic;
        }

        .thinking-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- NUPI CLOUD AGENT AUTO-LOADS -->
    <script src="/nupi-cloud-agent.js"></script>
</head>
<body>
    <div class="chat-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <i class="fas fa-arrow-left back-arrow"></i>
                    <input type="text" class="search-box" placeholder="Search">
                </div>
                <div class="top-bar-right">
                    <button class="icon-button"><i class="fas fa-columns"></i></button>
                    <button class="icon-button"><i class="fas fa-bars"></i></button>
                    <button class="icon-button"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #858585;">
        </div>

        <!-- Right Sidebar - Chat -->
        <div class="chat-sidebar">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-comment-dots"></i>
                    CHAT
                </div>
                <div class="chat-actions">
                    <button class="icon-button" onclick="addContext()"><i class="fas fa-plus"></i></button>
                    <button class="icon-button" onclick="refreshChat()"><i class="fas fa-redo"></i></button>
                    <button class="icon-button"><i class="fas fa-cog"></i></button>
                    <button class="icon-button"><i class="fas fa-ellipsis-v"></i></button>
                    <button class="icon-button"><i class="fas fa-expand"></i></button>
                    <button class="icon-button" onclick="closeChat()"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Todo List Section -->
            <div class="todo-section">
                <div class="todo-header" onclick="toggleTodos()">
                    <div>
                        <div class="todo-title">
                            <i class="fas fa-chevron-down"></i> Todos (<span id="todo-completed">0</span>/<span id="todo-total">0</span>)
                        </div>
                    </div>
                    <div class="todo-stats">
                        <i class="fas fa-check-circle"></i> Deploy to Railway and verify live
                    </div>
                </div>
                <div class="todo-list" id="todo-list">
                    <!-- Todos will be inserted here -->
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chat-messages">
                <div class="message">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">NUPI Assistant</span>
                            <span class="message-time">Just now</span>
                            <span class="context-badge">Claude 3.5</span>
                        </div>
                        <div class="message-text">
                            üëã Hello! I'm your autonomous AI assistant, powered by Claude 3.5 Sonnet and Tavily search.
                            <br><br>
                            I can help you with:
                            <br>
                            ‚Ä¢ ü§ñ Monitoring your 14 active agents
                            <br>
                            ‚Ä¢ üìä Analyzing network data from 192.168.12.x
                            <br>
                            ‚Ä¢ üåê Searching the web for information
                            <br>
                            ‚Ä¢ üíª Executing code and running commands
                            <br>
                            ‚Ä¢ üìù Managing your todos and tasks
                            <br><br>
                            What would you like to work on today?
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Status Bar -->
            <div class="agent-status">
                <div class="agent-indicator">
                    <span class="status-dot"></span>
                    <span class="agent-info">
                        <span class="agent-count" id="agent-count">0</span> agents active
                    </span>
                </div>
                <select class="model-selector" id="model-selector">
                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                    <option value="claude-3-opus">Claude 3 Opus</option>
                </select>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="input-toolbar">
                    <button class="toolbar-button" onclick="attachScreenshot()">
                        <i class="fas fa-camera"></i> Screenshot
                    </button>
                    <button class="toolbar-button" onclick="attachFile()">
                        <i class="fas fa-paperclip"></i> Attach
                    </button>
                    <button class="toolbar-button" onclick="toggleWebSearch()">
                        <i class="fas fa-globe"></i> Web Search
                    </button>
                </div>
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chat-input"
                        placeholder="Add context (#), extensions (@), commands (>)..."
                        onkeydown="handleKeyPress(event)"
                    ></textarea>
                    <button class="send-button" id="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let agentCount = 0;
        let todos = [];
        let webSearchEnabled = false;
        let currentAttachments = [];

        // Initialize
        async function init() {
            loadTodos();
            updateAgentCount();
            setInterval(updateAgentCount, 3000); // Update every 3 seconds
            autoScroll();
        }

        // Load Todos
        async function loadTodos() {
            // TODO: Load from API
            todos = [
                { id: 1, title: "Start continuous harvester with position reporting", completed: true },
                { id: 2, title: "Open visualizer-real.html to verify real-time tracking", completed: true },
                { id: 3, title: "Design GitHub Copilot-style chat interface", completed: false },
                { id: 4, title: "Implement autonomous Claude agent system", completed: false },
                { id: 5, title: "Add todo list management UI", completed: false },
            ];
            renderTodos();
        }

        function renderTodos() {
            const todoList = document.getElementById('todo-list');
            const completed = todos.filter(t => t.completed).length;
            document.getElementById('todo-completed').textContent = completed;
            document.getElementById('todo-total').textContent = todos.length;

            todoList.innerHTML = todos.map(todo => `
                <div class="todo-item ${todo.completed ? 'completed' : ''}">
                    <input 
                        type="checkbox" 
                        class="todo-checkbox" 
                        ${todo.completed ? 'checked' : ''}
                        onchange="toggleTodo(${todo.id})"
                    >
                    <span>${todo.title}</span>
                </div>
            `).join('');
        }

        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                renderTodos();
            }
        }

        function toggleTodos() {
            const todoList = document.getElementById('todo-list');
            todoList.style.display = todoList.style.display === 'none' ? 'block' : 'none';
        }

        // Update Agent Count
        async function updateAgentCount() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                agentCount = data.count || 0;
                document.getElementById('agent-count').textContent = agentCount;
                
                // Update status dot
                const statusDot = document.querySelector('.status-dot');
                if (agentCount > 0) {
                    statusDot.classList.remove('busy');
                } else {
                    statusDot.classList.add('busy');
                }
            } catch (error) {
                console.error('Failed to fetch agents:', error);
            }
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage('user', message, currentAttachments);
            input.value = '';
            currentAttachments = [];

            // Show typing indicator
            showTypingIndicator();

            try {
                // Call AI API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        model: document.getElementById('model-selector').value,
                        webSearch: webSearchEnabled,
                        attachments: currentAttachments
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();

                // Add AI response
                addMessage('ai', data.response);
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('ai', '‚ùå Error: ' + error.message);
            }
        }

        function addMessage(type, text, attachments = []) {
            const messagesDiv = document.getElementById('chat-messages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageHTML = `
                <div class="message">
                    <div class="message-avatar ${type}">${type === 'user' ? 'JD' : 'AI'}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">${type === 'user' ? 'You' : 'NUPI Assistant'}</span>
                            <span class="message-time">${time}</span>
                            ${type === 'ai' ? '<span class="context-badge">Claude 3.5</span>' : ''}
                        </div>
                        <div class="message-text">${formatMessage(text)}</div>
                        ${attachments.length > 0 ? `
                            <div class="attachments">
                                ${attachments.map(att => `
                                    <div class="attachment">
                                        <i class="fas fa-${att.type === 'image' ? 'image' : 'file'}"></i>
                                        ${att.name}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            messagesDiv.insertAdjacentHTML('beforeend', messageHTML);
            autoScroll();
        }

        function formatMessage(text) {
            // Handle undefined or null text
            if (!text) return '';
            
            // Convert to string if not already
            text = String(text);
            
            // Convert markdown-style code blocks
            text = text.replace(/```(.*?)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Convert inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Convert line breaks
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingHTML = `
                <div class="message typing-message">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="thinking">
                            <i class="fas fa-spinner thinking-icon"></i>
                            Thinking...
                        </div>
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.insertAdjacentHTML('beforeend', typingHTML);
            autoScroll();
        }

        function removeTypingIndicator() {
            const typing = document.querySelector('.typing-message');
            if (typing) typing.remove();
        }

        function autoScroll() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Toolbar Functions
        function attachScreenshot() {
            alert('Screenshot feature coming soon!');
        }

        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = (e) => {
                const file = e.target.files[0];
                currentAttachments.push({
                    type: file.type.startsWith('image/') ? 'image' : 'file',
                    name: file.name
                });
                alert(`Attached: ${file.name}`);
            };
            input.click();
        }

        function toggleWebSearch() {
            webSearchEnabled = !webSearchEnabled;
            const button = event.target.closest('.toolbar-button');
            button.style.background = webSearchEnabled ? '#007acc' : 'transparent';
            alert(`Web search ${webSearchEnabled ? 'enabled' : 'disabled'}`);
        }

        function addContext() {
            alert('Context menu coming soon!');
        }

        function refreshChat() {
            location.reload();
        }

        function closeChat() {
            if (confirm('Close chat?')) {
                window.location.href = '/';
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
