<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUPI Control Center - All-in-One Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }
        .login-box h1 { text-align: center; margin-bottom: 30px; font-size: 32px; }
        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }
        .login-box button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        .error { color: #ef4444; text-align: center; margin-top: 15px; display: none; }
        
        /* Main Dashboard */
        .dashboard { display: none; padding: 20px; }
        .header {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 42px; margin-bottom: 10px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }
        .tab:hover { transform: translateY(-2px); }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        .stat-card h3 { font-size: 40px; margin-bottom: 10px; color: #4ade80; }
        .stat-card p { color: rgba(255, 255, 255, 0.8); font-size: 14px; }
        
        /* Network Map */
        .network-map {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        #mapCanvas {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            background: rgba(15, 32, 39, 0.5);
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .data-table th {
            background: rgba(0, 0, 0, 0.3);
            color: #4ade80;
            font-weight: 600;
        }
        
        /* Activity Log */
        .activity-log {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4ade80;
        }
        .log-time { color: #9ca3af; font-size: 12px; margin-bottom: 5px; }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: #fff;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        
        /* Health Status */
        .health-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .health-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .health-status { color: #4ade80; font-weight: 600; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>üõ°Ô∏è NUPI Control Center</h1>
            <p style="text-align: center; margin-bottom: 30px; color: rgba(255,255,255,0.7);">
                All-in-One Dashboard: Network Map, Data, Health & Control
            </p>
            <input type="password" id="passwordInput" placeholder="Enter Password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Access Dashboard</button>
            <p class="error" id="error">Incorrect password</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>üó∫Ô∏è NUPI Control Center</h1>
            <p>Network Map ‚Ä¢ Data Viewer ‚Ä¢ System Health ‚Ä¢ Agent Control</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('network')">üó∫Ô∏è Network Map</div>
            <div class="tab" onclick="switchTab('data')">üìä Data Viewer</div>
            <div class="tab" onclick="switchTab('health')">üíö System Health</div>
            <div class="tab" onclick="switchTab('control')">üéÆ Agent Control</div>
        </div>

        <!-- Network Map Tab -->
        <div class="tab-content active" id="networkTab">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="agentCount">0</h3>
                    <p>Active Agents</p>
                </div>
                <div class="stat-card">
                    <h3 id="deviceCount">0</h3>
                    <p>Devices Found</p>
                </div>
                <div class="stat-card">
                    <h3 id="hopCount">0</h3>
                    <p>Total Hops</p>
                </div>
                <div class="stat-card">
                    <h3 id="dataPoints">0</h3>
                    <p>Data Points</p>
                </div>
            </div>

            <div class="network-map">
                <h2 style="margin-bottom: 20px;">Live Network Visualization</h2>
                <canvas id="mapCanvas"></canvas>
            </div>

            <div class="activity-log">
                <h2 style="margin-bottom: 20px;">üìã Activity Log</h2>
                <div id="logEntries"></div>
            </div>
        </div>

        <!-- Data Viewer Tab -->
        <div class="tab-content" id="dataTab">
            <div class="controls">
                <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-success" onclick="downloadData()">‚¨áÔ∏è Download All</button>
                <button class="btn btn-warning" onclick="sendToTelegram()">üì± Telegram</button>
            </div>

            <div class="health-box">
                <h2 style="margin-bottom: 20px;">üìä Data Summary</h2>
                <div id="dataSummary">Loading...</div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px;">
                <h2 style="margin-bottom: 20px;">Recent Data</h2>
                <div id="recentData" style="max-height: 500px; overflow-y: auto;">Loading...</div>
            </div>
        </div>

        <!-- System Health Tab -->
        <div class="tab-content" id="healthTab">
            <div class="health-box">
                <h2 style="margin-bottom: 20px;">üíö System Health Status</h2>
                <div id="healthStatus">
                    <div class="health-item">
                        <span>Main Server</span>
                        <span class="health-status" id="serverHealth">Checking...</span>
                    </div>
                    <div class="health-item">
                        <span>Database</span>
                        <span class="health-status" id="dbHealth">Checking...</span>
                    </div>
                    <div class="health-item">
                        <span>API Endpoints</span>
                        <span class="health-status" id="apiHealth">Checking...</span>
                    </div>
                    <div class="health-item">
                        <span>Local Agents</span>
                        <span class="health-status" id="agentsHealth">Checking...</span>
                    </div>
                    <div class="health-item">
                        <span>Network Scanner</span>
                        <span class="health-status" id="scannerHealth">Checking...</span>
                    </div>
                </div>
            </div>

            <div class="health-box">
                <h2 style="margin-bottom: 20px;">üìà System Metrics</h2>
                <div id="systemMetrics"></div>
            </div>
        </div>

        <!-- Agent Control Tab -->
        <div class="tab-content" id="controlTab">
            <div class="controls">
                <button class="btn btn-success" onclick="startAgents()">‚ñ∂Ô∏è Start All Agents</button>
                <button class="btn btn-warning" onclick="pauseAgents()">‚è∏Ô∏è Pause Agents</button>
                <button class="btn btn-danger" onclick="stopAgents()">‚èπÔ∏è Stop All</button>
                <button class="btn btn-primary" onclick="collectData()">üìä Force Collect</button>
            </div>

            <div class="health-box">
                <h2 style="margin-bottom: 20px;">ü§ñ Agent Status</h2>
                <div id="agentStatus">Loading agent information...</div>
            </div>
        </div>
    </div>

    <script>
        // üåê NUPI CLOUD AGENT - 24/7 Connection
        const CLOUD_API = 'https://nupidesktopai.com';
        const PASSWORD = 'Jedariusm';
        const API_KEY = 'NUPI_TRAVELLING_AGENT_KEY_MILITARY_c8f2a9e7b4d6f3a1e9c5b7d2f8a4e6c3';
        const ADMIN_PASSWORD = 'Jedariusm';

        let canvas, ctx;
        let agents = [], devices = [];
        let cloudAgentStatus = { connected: false, lastSync: null, uptime: 0 };
        
        // üîÑ 24/7 Cloud Agent Sync - Keeps running continuously
        function syncWithCloudAgent() {
            setInterval(async () => {
                try {
                    const response = await fetch(`${CLOUD_API}/api/agents/locations`);
                    if (response.ok) {
                        const data = await response.json();
                        cloudAgentStatus.connected = true;
                        cloudAgentStatus.lastSync = new Date().toISOString();
                        cloudAgentStatus.uptime++;
                        
                        // Update local agent tracking with cloud data
                        if (data.agents && data.agents.length > 0) {
                            agents = data.agents;
                            console.log(`‚úÖ Cloud sync: ${agents.length} agents monitored`);
                        }
                    }
                } catch (error) {
                    cloudAgentStatus.connected = false;
                    console.error('‚ùå Cloud Agent sync failed:', error);
                }
            }, 5000); // Sync every 5 seconds for 24/7 monitoring
        }
        
        // ‚ö° Auto-register this monitoring dashboard with Cloud Agent
        async function registerMonitoringDashboard() {
            try {
                await fetch(`${CLOUD_API}/api/agent/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_id: 'travelling-agents-monitor',
                        location: 'Monitoring Dashboard',
                        network: 'Admin Control Panel',
                        type: 'monitor'
                    })
                });
                console.log('‚úÖ Monitoring dashboard registered with Cloud Agent');
            } catch (error) {
                console.error('Registration error:', error);
            }
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initDashboard();
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Load tab-specific data
            if (tab === 'health') checkHealth();
            if (tab === 'data') refreshData();
            if (tab === 'control') loadAgentStatus();
        }

        function initDashboard() {
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            updateDashboard();
            setInterval(updateDashboard, 3000);
            drawNetwork();
            setInterval(drawNetwork, 1000);
        }

        async function updateDashboard() {
            try {
                const response = await fetch('/api/agents/locations', {
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    agents = data.agents || [];
                    devices = data.devices || [];
                    
                    document.getElementById('agentCount').textContent = agents.length;
                    document.getElementById('deviceCount').textContent = devices.length;
                    document.getElementById('hopCount').textContent = data.total_hops || 0;
                    document.getElementById('dataPoints').textContent = data.data_points || 0;
                    
                    addLogEntry(`Updated: ${agents.length} agents, ${devices.length} devices`);
                }
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        function drawNetwork() {
            if (!ctx) return;
            
            ctx.fillStyle = 'rgba(15, 32, 39, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            
            // Draw devices
            devices.forEach((device, i) => {
                const x = 100 + (i % 5) * 150;
                const y = 100 + Math.floor(i / 5) * 100;
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText(device.ip || 'Device', x - 30, y + 35);
            });
            
            // Draw agents (pulsing)
            const pulse = Math.sin(Date.now() / 500) * 5 + 20;
            agents.forEach((agent, i) => {
                const x = 200 + (i % 4) * 200;
                const y = 150 + Math.floor(i / 4) * 120;
                ctx.fillStyle = '#10b981';
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(x, y, pulse, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(x, y, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('ü§ñ Agent', x - 25, y - 25);
            });
        }

        function addLogEntry(message) {
            const log = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<div class="log-time">${new Date().toLocaleTimeString()}</div><div>${message}</div>`;
            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 20) log.removeChild(log.lastChild);
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/collected-data/summary', {
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });
                const data = await response.json();
                
                document.getElementById('dataSummary').innerHTML = `
                    <div class="health-item"><span>Total Data Points</span><span class="health-status">${data.total_count || 0}</span></div>
                    <div class="health-item"><span>Devices Found</span><span class="health-status">${data.devices_found || 0}</span></div>
                    <div class="health-item"><span>Active Agents</span><span class="health-status">${data.active_agents || 0}</span></div>
                    <div class="health-item"><span>Website Visitors</span><span class="health-status">${data.website_visitors || 0}</span></div>
                `;
                
                const recent = data.recent || [];
                let html = '<table class="data-table"><tr><th>Time</th><th>Type</th><th>Data</th></tr>';
                recent.slice(0, 20).forEach(item => {
                    html += `<tr><td>${new Date(item.timestamp).toLocaleString()}</td><td>${item.agent_type || 'unknown'}</td><td>${JSON.stringify(item).substring(0, 100)}...</td></tr>`;
                });
                html += '</table>';
                document.getElementById('recentData').innerHTML = html || '<p>No data yet</p>';
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('serverHealth').textContent = data.status === 'healthy' ? '‚úÖ Online' : '‚ùå Offline';
                document.getElementById('dbHealth').textContent = '‚úÖ Connected';
                document.getElementById('apiHealth').textContent = '‚úÖ Operational';
                document.getElementById('agentsHealth').textContent = `‚úÖ ${agents.length} Active`;
                document.getElementById('scannerHealth').textContent = `‚úÖ ${devices.length} Devices`;
                
                document.getElementById('systemMetrics').innerHTML = `
                    <div class="health-item"><span>Uptime</span><span class="health-status">Active</span></div>
                    <div class="health-item"><span>Last Check</span><span class="health-status">${new Date().toLocaleTimeString()}</span></div>
                    <div class="health-item"><span>Status</span><span class="health-status">${data.status}</span></div>
                `;
            } catch (error) {
                document.getElementById('serverHealth').textContent = '‚ùå Error';
            }
        }

        function loadAgentStatus() {
            document.getElementById('agentStatus').innerHTML = `
                <div class="health-item"><span>Local Network Agent</span><span class="health-status">‚úÖ Scanning 192.168.12.x</span></div>
                <div class="health-item"><span>Found Devices</span><span class="health-status">${devices.length} devices</span></div>
                <div class="health-item"><span>Memory Usage</span><span class="health-status">< 100MB</span></div>
                <div class="health-item"><span>CPU Usage</span><span class="health-status">< 10%</span></div>
            `;
        }

        async function downloadData() {
            try {
                const response = await fetch('/api/collected-data/full', {
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nupi-data-${Date.now()}.json`;
                a.click();
                addLogEntry('Data downloaded successfully');
            } catch (error) {
                addLogEntry('Failed to download data');
            }
        }

        async function sendToTelegram() {
            try {
                await fetch('/api/telegram/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
                    body: JSON.stringify({ message: `NUPI Report: ${agents.length} agents, ${devices.length} devices` })
                });
                addLogEntry('Report sent to Telegram');
            } catch (error) {
                addLogEntry('Failed to send to Telegram');
            }
        }

        function startAgents() { addLogEntry('Starting all agents...'); }
        function pauseAgents() { addLogEntry('Pausing all agents...'); }
        function stopAgents() { addLogEntry('Stopping all agents...'); }
        function collectData() { addLogEntry('Collecting data from all agents...'); refreshData(); }
    </script>
</body>
</html>
